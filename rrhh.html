<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRHH - C&A Cloud Factory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-slide-out { animation: slide-out 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-slate-900">
    
    <!-- Navbar -->
    <nav class="bg-gray-800/90 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shoe-prints text-white"></i>
                    </div>
                    <span class="text-white font-bold text-lg hidden sm:block">C&A Cloud Factory</span>
                </div>

                <div id="navMenu" class="hidden md:flex items-center gap-2"></div>

                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p id="userName" class="text-white text-sm font-medium">-</p>
                        <p id="userRole" class="text-gray-400 text-xs">-</p>
                    </div>
                    <button id="logoutBtn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition" title="Cerrar Sesi√≥n">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-users mr-3 text-purple-500"></i>
                    Recursos Humanos
                </h1>
                <p class="text-gray-400 mt-2">Gesti√≥n de personal, asistencia y sanciones</p>
            </div>
            <button id="addEmployeeBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl shadow-lg transition flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                <span>Nuevo Empleado</span>
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-500 text-xl"></i>
                    </div>
                </div>
                <p id="totalEmployees" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Total Empleados</p>
            </div>

            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-green-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-check text-green-500 text-xl"></i>
                    </div>
                </div>
                <p id="activeEmployees" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Activos</p>
            </div>

            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-red-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-slash text-red-500 text-xl"></i>
                    </div>
                </div>
                <p id="sanctionedEmployees" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Sancionados</p>
            </div>

            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-amber-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-amber-500 text-xl"></i>
                    </div>
                </div>
                <p id="lateToday" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Llegaron Tarde Hoy</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-700 pb-2 overflow-x-auto">
            <button class="tab-btn px-4 py-2 text-white bg-purple-600 rounded-lg transition" data-tab="employees">
                <i class="fas fa-users mr-2"></i>Empleados
            </button>
            <button class="tab-btn px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition" data-tab="attendance">
                <i class="fas fa-calendar-check mr-2"></i>Asistencia
            </button>
            <button class="tab-btn px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition" data-tab="sanctions">
                <i class="fas fa-gavel mr-2"></i>Sanciones
            </button>
        </div>

        <!-- Employees Tab -->
        <div id="employeesTab" class="tab-content">
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-700">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            <input 
                                type="text" 
                                id="searchEmployees" 
                                placeholder="Buscar empleado..."
                                class="w-full pl-12 pr-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                        </div>
                        <select id="filterStatus" class="px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="all">Todos los estados</option>
                            <option value="activo">Activos</option>
                            <option value="sancionado">Sancionados</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Empleado</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Cargo</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Tipo Pago</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500">Cargando empleados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendanceTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Register Attendance -->
                <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-user-clock mr-2 text-amber-500"></i>
                        Registrar Asistencia
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Empleado</label>
                            <select id="attendanceEmployee" class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Seleccionar empleado...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Hora de Entrada</label>
                            <input 
                                type="time" 
                                id="attendanceTime"
                                class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                        </div>
                        
                        <div id="lateWarning" class="hidden bg-red-900/50 border border-red-700 rounded-xl p-4">
                            <p class="text-red-300 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Llegada tard√≠a (despu√©s de 7:00 AM)</span>
                            </p>
                        </div>
                        
                        <button id="registerAttendanceBtn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">
                            <i class="fas fa-check mr-2"></i>
                            Registrar Entrada
                        </button>
                    </div>
                </div>

                <!-- Today's Attendance -->
                <div class="lg:col-span-2 bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                        Asistencia de Hoy
                    </h3>
                    
                    <div id="todayAttendanceList" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">Sin registros de asistencia hoy</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sanctions Tab -->
        <div id="sanctionsTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Register Sanction -->
                <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-gavel mr-2 text-red-500"></i>
                        Aplicar Sanci√≥n
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Empleado</label>
                            <select id="sanctionEmployee" class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Seleccionar empleado...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Motivo de la Sanci√≥n</label>
                            <textarea 
                                id="sanctionReason"
                                rows="3"
                                placeholder="Describa el motivo de la sanci√≥n..."
                                class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 resize-none"
                            ></textarea>
                        </div>
                        
                        <div class="bg-amber-900/30 border border-amber-700/50 rounded-xl p-4">
                            <p class="text-amber-300 text-sm flex items-start gap-2">
                                <i class="fas fa-info-circle mt-0.5"></i>
                                <span>Al sancionar, el empleado no podr√° registrar producci√≥n hasta que se levante la sanci√≥n.</span>
                            </p>
                        </div>
                        
                        <button id="applySanctionBtn" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition">
                            <i class="fas fa-ban mr-2"></i>
                            Aplicar Sanci√≥n
                        </button>
                    </div>
                </div>

                <!-- Active Sanctions -->
                <div class="lg:col-span-2 bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-exclamation-triangle mr-2 text-amber-500"></i>
                        Sanciones Activas
                    </h3>
                    
                    <div id="activeSanctionsList" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">No hay sanciones activas</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-white">Nuevo Empleado</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="employeeForm" class="space-y-4">
                <input type="hidden" id="employeeId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nombre Completo</label>
                    <input 
                        type="text" 
                        id="employeeName"
                        required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="Nombre del empleado"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Correo Electr√≥nico</label>
                    <input 
                        type="email" 
                        id="employeeEmail"
                        required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="correo@empresa.com"
                    >
                </div>
                
                <div id="passwordField">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="employeePassword"
                        minlength="6"
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="M√≠nimo 6 caracteres"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Rol del Sistema</label>
                    <select id="employeeRole" required class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="operario">Operario</option>
                        <option value="admin_rrhh">Administrador RRHH</option>
                        <option value="admin_finanzas">Administrador Finanzas</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Cargo / Funci√≥n</label>
                    <select id="employeeCargo" class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="guarnecedor">Guarnecedor</option>
                        <option value="solador">Solador</option>
                        <option value="cortador">Cortador</option>
                        <option value="armador">Armador</option>
                        <option value="montador">Montador</option>
                        <option value="terminador">Terminador</option>
                        <option value="empacador">Empacador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="administrativo">Administrativo</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Tipo de Pago</label>
                    <select id="employeeTipoPago" class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="por_par">üí∞ Tarifa por Par</option>
                        <option value="salario_fijo">üìã Salario Fijo</option>
                        <option value="quincenal">üìÖ Quincenal</option>
                        <option value="mensual">üóìÔ∏è Mensual</option>
                    </select>
                </div>
                
                <div id="tarifaParField">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Tarifa por Par (COP)</label>
                    <input 
                        type="number" 
                        id="employeeTarifa"
                        min="0"
                        step="100"
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="5000"
                    >
                </div>

                <div id="salarioFijoField" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Salario (COP)</label>
                    <input 
                        type="number" 
                        id="employeeSalario"
                        min="0"
                        step="1000"
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="1300000"
                    >
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelModalBtn" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-xl transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">
                        <i class="fas fa-save mr-2"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-600 text-sm">C&A Manufacturas ¬© 2024 - Bucaramanga, Colombia</p>
        </div>
    </footer>

    <script type="module">
        import { checkAuthAndRedirect, logout, ROLES } from './js/auth.js';
        import { getNavigationMenu, getRoleName } from './js/roles.js';
        import { formatCurrency, formatDateTime, formatTime, isLate, getDayStart, showToast, showConfirm } from './js/utils.js';
        import { auth, db, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, query, where, orderBy, onSnapshot, Timestamp, createUserWithEmailAndPassword } from './js/firebase-init.js';

        let employees = [];
        let currentTab = 'employees';

        // Inicializar
        async function init() {
            try {
                const { userData } = await checkAuthAndRedirect([ROLES.ADMIN_RRHH, ROLES.ADMIN_FINANZAS]);
                
                document.getElementById('userName').textContent = userData.nombre;
                document.getElementById('userRole').textContent = getRoleName(userData.rol);
                
                generateNavMenu(userData.rol);
                
                // Cargar datos
                await loadEmployees();
                loadTodayAttendance();
                loadActiveSanctions();
                
                // Event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error de autenticaci√≥n:', error);
            }
        }

        function generateNavMenu(rol) {
            const menu = getNavigationMenu(rol);
            const navMenu = document.getElementById('navMenu');
            navMenu.innerHTML = menu.map(item => `
                <a href="${item.href}" class="px-4 py-2 text-gray-300 hover:text-white hover:bg-gray-700/50 rounded-lg transition flex items-center gap-2 ${item.href === 'rrhh.html' ? 'bg-gray-700/50 text-white' : ''}">
                    <i class="fas ${item.icon}"></i>
                    <span>${item.name}</span>
                </a>
            `).join('');
        }

        // Cargar empleados
        async function loadEmployees() {
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                employees = [];
                
                let active = 0, sanctioned = 0;
                
                snapshot.forEach(doc => {
                    const emp = { uid: doc.id, ...doc.data() };
                    employees.push(emp);
                    
                    if (emp.estado === 'sancionado') sanctioned++;
                    else active++;
                });
                
                document.getElementById('totalEmployees').textContent = employees.length;
                document.getElementById('activeEmployees').textContent = active;
                document.getElementById('sanctionedEmployees').textContent = sanctioned;
                
                renderEmployeesTable();
                populateEmployeeSelects();
                
            } catch (error) {
                console.error('Error cargando empleados:', error);
            }
        }

        // Renderizar tabla de empleados
        function renderEmployeesTable(filter = '') {
            const tbody = document.getElementById('employeesTableBody');
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = employees.filter(emp => {
                const matchesSearch = emp.nombre.toLowerCase().includes(filter.toLowerCase()) ||
                                     emp.email?.toLowerCase().includes(filter.toLowerCase());
                const matchesStatus = statusFilter === 'all' || emp.estado === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No se encontraron empleados</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(emp => {
                const statusColor = emp.estado === 'sancionado' ? 'bg-red-600/20 text-red-400' : 'bg-green-600/20 text-green-400';
                const statusText = emp.estado === 'sancionado' ? 'Sancionado' : 'Activo';
                const cargoNames = {
                    'guarnecedor': 'Guarnecedor', 'solador': 'Solador', 'cortador': 'Cortador',
                    'armador': 'Armador', 'montador': 'Montador', 'terminador': 'Terminador',
                    'empacador': 'Empacador', 'supervisor': 'Supervisor', 'administrativo': 'Administrativo', 'otro': 'Otro'
                };
                const tipoPagoLabels = {
                    'por_par': 'üí∞ Por Par', 'salario_fijo': 'üìã Fijo',
                    'quincenal': 'üìÖ Quincenal', 'mensual': 'üóìÔ∏è Mensual'
                };
                const valorPago = emp.tipo_pago === 'por_par' || !emp.tipo_pago 
                    ? formatCurrency(emp.tarifa_par || 0) + '/par'
                    : formatCurrency(emp.salario || 0);
                
                return `
                    <tr class="hover:bg-gray-700/30 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-gray-400"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">${emp.nombre}</p>
                                    <p class="text-gray-500 text-sm">${emp.email || '-'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-300">${cargoNames[emp.cargo] || getRoleName(emp.rol)}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-xs px-2 py-1 rounded-full bg-blue-600/20 text-blue-400">${tipoPagoLabels[emp.tipo_pago] || 'üí∞ Por Par'}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-white font-medium">${valorPago}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <button class="p-2 text-gray-400 hover:text-blue-400 hover:bg-blue-600/20 rounded-lg transition edit-employee-btn" data-uid="${emp.uid}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${emp.estado === 'sancionado' ? `
                                    <button class="p-2 text-gray-400 hover:text-green-400 hover:bg-green-600/20 rounded-lg transition lift-sanction-btn" data-uid="${emp.uid}" data-name="${emp.nombre}" title="Levantar Sanci√≥n">
                                        <i class="fas fa-user-check"></i>
                                    </button>
                                ` : `
                                    <button class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-600/20 rounded-lg transition quick-sanction-btn" data-uid="${emp.uid}" data-name="${emp.nombre}" title="Sancionar">
                                        <i class="fas fa-user-slash"></i>
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Event listeners para botones de la tabla
            document.querySelectorAll('.edit-employee-btn').forEach(btn => {
                btn.addEventListener('click', () => editEmployee(btn.dataset.uid));
            });
            
            document.querySelectorAll('.quick-sanction-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const confirmed = await showConfirm('Sancionar Empleado', `¬øEst√° seguro de sancionar a ${btn.dataset.name}?`);
                    if (confirmed) {
                        await quickSanction(btn.dataset.uid, btn.dataset.name);
                    }
                });
            });
            
            document.querySelectorAll('.lift-sanction-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const confirmed = await showConfirm('Levantar Sanci√≥n', `¬øEst√° seguro de levantar la sanci√≥n a ${btn.dataset.name}?`);
                    if (confirmed) {
                        await liftSanction(btn.dataset.uid);
                    }
                });
            });
        }

        // Poblar selects de empleados
        function populateEmployeeSelects() {
            const operarios = employees.filter(e => e.rol === 'operario');
            
            const attendanceSelect = document.getElementById('attendanceEmployee');
            const sanctionSelect = document.getElementById('sanctionEmployee');
            
            const options = operarios.map(e => `<option value="${e.uid}">${e.nombre}</option>`).join('');
            
            attendanceSelect.innerHTML = '<option value="">Seleccionar empleado...</option>' + options;
            sanctionSelect.innerHTML = '<option value="">Seleccionar empleado...</option>' + 
                operarios.filter(e => e.estado !== 'sancionado').map(e => `<option value="${e.uid}">${e.nombre}</option>`).join('');
        }

        // Cargar asistencia de hoy
        function loadTodayAttendance() {
            const today = getDayStart();
            
            const q = query(
                collection(db, 'asistencia'),
                where('fecha', '>=', Timestamp.fromDate(today)),
                orderBy('fecha', 'desc')
            );
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('todayAttendanceList');
                let lateCount = 0;
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Sin registros de asistencia hoy</p>';
                    document.getElementById('lateToday').textContent = '0';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const record = doc.data();
                    const late = isLate(record.fecha);
                    if (late) lateCount++;
                    
                    list.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-700/50 rounded-lg p-4 ${late ? 'border-l-4 border-red-500' : ''}">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${late ? 'bg-red-600/20' : 'bg-green-600/20'} rounded-full flex items-center justify-center">
                                    <i class="fas ${late ? 'fa-clock text-red-500' : 'fa-check text-green-500'}"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">${record.nombre_empleado}</p>
                                    <p class="text-gray-500 text-sm">Entrada: ${formatTime(record.fecha)}</p>
                                </div>
                            </div>
                            ${late ? '<span class="px-3 py-1 bg-red-600/20 text-red-400 text-xs rounded-full">TARDE</span>' : ''}
                        </div>
                    `;
                });
                
                document.getElementById('lateToday').textContent = lateCount;
            });
        }

        // Cargar sanciones activas
        function loadActiveSanctions() {
            const q = query(
                collection(db, 'sanciones'),
                where('activa', '==', true),
                orderBy('fecha', 'desc')
            );
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('activeSanctionsList');
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">No hay sanciones activas</p>';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const sanction = { id: doc.id, ...doc.data() };
                    
                    list.innerHTML += `
                        <div class="bg-red-900/20 border border-red-700/50 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <p class="text-white font-medium">${sanction.nombre_empleado}</p>
                                    <p class="text-gray-500 text-sm">${formatDateTime(sanction.fecha)}</p>
                                </div>
                                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg transition lift-sanction-from-list" data-id="${sanction.id}" data-uid="${sanction.uid_operario}">
                                    Levantar
                                </button>
                            </div>
                            <p class="text-gray-300 text-sm">${sanction.motivo}</p>
                        </div>
                    `;
                });
                
                // Event listeners
                document.querySelectorAll('.lift-sanction-from-list').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await liftSanctionById(btn.dataset.id, btn.dataset.uid);
                    });
                });
            });
        }

        // Registrar asistencia
        async function registerAttendance() {
            const employeeId = document.getElementById('attendanceEmployee').value;
            const timeInput = document.getElementById('attendanceTime').value;
            
            if (!employeeId || !timeInput) {
                showToast('Complete todos los campos', 'warning');
                return;
            }
            
            const employee = employees.find(e => e.uid === employeeId);
            if (!employee) return;
            
            const [hours, minutes] = timeInput.split(':');
            const now = new Date();
            now.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            try {
                await addDoc(collection(db, 'asistencia'), {
                    uid_empleado: employeeId,
                    nombre_empleado: employee.nombre,
                    fecha: Timestamp.fromDate(now),
                    tarde: parseInt(hours) > 7 || (parseInt(hours) === 7 && parseInt(minutes) > 0)
                });
                
                showToast('Asistencia registrada correctamente', 'success');
                document.getElementById('attendanceEmployee').value = '';
                document.getElementById('attendanceTime').value = '';
                document.getElementById('lateWarning').classList.add('hidden');
                
            } catch (error) {
                console.error('Error registrando asistencia:', error);
                showToast('Error al registrar asistencia', 'error');
            }
        }

        // Aplicar sanci√≥n
        async function applySanction() {
            const employeeId = document.getElementById('sanctionEmployee').value;
            const reason = document.getElementById('sanctionReason').value.trim();
            
            if (!employeeId || !reason) {
                showToast('Complete todos los campos', 'warning');
                return;
            }
            
            const employee = employees.find(e => e.uid === employeeId);
            if (!employee) return;
            
            try {
                // Crear registro de sanci√≥n
                await addDoc(collection(db, 'sanciones'), {
                    uid_operario: employeeId,
                    nombre_empleado: employee.nombre,
                    motivo: reason,
                    fecha: Timestamp.now(),
                    activa: true
                });
                
                // Actualizar estado del empleado
                await updateDoc(doc(db, 'users', employeeId), {
                    estado: 'sancionado'
                });
                
                showToast(`Sanci√≥n aplicada a ${employee.nombre}`, 'success');
                document.getElementById('sanctionEmployee').value = '';
                document.getElementById('sanctionReason').value = '';
                
                await loadEmployees();
                
            } catch (error) {
                console.error('Error aplicando sanci√≥n:', error);
                showToast('Error al aplicar sanci√≥n', 'error');
            }
        }

        // Sanci√≥n r√°pida desde la tabla
        async function quickSanction(uid, name) {
            try {
                await addDoc(collection(db, 'sanciones'), {
                    uid_operario: uid,
                    nombre_empleado: name,
                    motivo: 'Sanci√≥n r√°pida desde panel de administraci√≥n',
                    fecha: Timestamp.now(),
                    activa: true
                });
                
                await updateDoc(doc(db, 'users', uid), {
                    estado: 'sancionado'
                });
                
                showToast(`Sanci√≥n aplicada a ${name}`, 'success');
                await loadEmployees();
                
            } catch (error) {
                console.error('Error aplicando sanci√≥n:', error);
                showToast('Error al aplicar sanci√≥n', 'error');
            }
        }

        // Levantar sanci√≥n
        async function liftSanction(uid) {
            try {
                // Desactivar todas las sanciones activas del empleado
                const sanctionsQuery = query(
                    collection(db, 'sanciones'),
                    where('uid_operario', '==', uid),
                    where('activa', '==', true)
                );
                
                const snapshot = await getDocs(sanctionsQuery);
                
                for (const docSnap of snapshot.docs) {
                    await updateDoc(doc(db, 'sanciones', docSnap.id), {
                        activa: false,
                        fecha_levantada: Timestamp.now()
                    });
                }
                
                // Actualizar estado del empleado
                await updateDoc(doc(db, 'users', uid), {
                    estado: 'activo'
                });
                
                showToast('Sanci√≥n levantada correctamente', 'success');
                await loadEmployees();
                
            } catch (error) {
                console.error('Error levantando sanci√≥n:', error);
                showToast('Error al levantar sanci√≥n', 'error');
            }
        }

        // Levantar sanci√≥n por ID
        async function liftSanctionById(sanctionId, uid) {
            try {
                await updateDoc(doc(db, 'sanciones', sanctionId), {
                    activa: false,
                    fecha_levantada: Timestamp.now()
                });
                
                await updateDoc(doc(db, 'users', uid), {
                    estado: 'activo'
                });
                
                showToast('Sanci√≥n levantada correctamente', 'success');
                await loadEmployees();
                
            } catch (error) {
                console.error('Error levantando sanci√≥n:', error);
                showToast('Error al levantar sanci√≥n', 'error');
            }
        }

        // Editar empleado
        function editEmployee(uid) {
            const employee = employees.find(e => e.uid === uid);
            if (!employee) return;
            
            document.getElementById('modalTitle').textContent = 'Editar Empleado';
            document.getElementById('employeeId').value = uid;
            document.getElementById('employeeName').value = employee.nombre;
            document.getElementById('employeeEmail').value = employee.email || '';
            document.getElementById('employeeRole').value = employee.rol;
            document.getElementById('employeeCargo').value = employee.cargo || 'guarnecedor';
            document.getElementById('employeeTipoPago').value = employee.tipo_pago || 'por_par';
            document.getElementById('employeeTarifa').value = employee.tarifa_par || 5000;
            document.getElementById('employeeSalario').value = employee.salario || 1300000;
            document.getElementById('passwordField').classList.add('hidden');
            
            togglePaymentFields(employee.tipo_pago || 'por_par');
            
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        function togglePaymentFields(tipoPago) {
            const tarifaField = document.getElementById('tarifaParField');
            const salarioField = document.getElementById('salarioFijoField');
            
            if (tipoPago === 'por_par') {
                tarifaField.classList.remove('hidden');
                salarioField.classList.add('hidden');
            } else {
                tarifaField.classList.add('hidden');
                salarioField.classList.remove('hidden');
            }
        }

        // Guardar empleado
        async function saveEmployee(e) {
            e.preventDefault();
            
            const uid = document.getElementById('employeeId').value;
            const nombre = document.getElementById('employeeName').value.trim();
            const email = document.getElementById('employeeEmail').value.trim();
            const rol = document.getElementById('employeeRole').value;
            const cargo = document.getElementById('employeeCargo').value;
            const tipoPago = document.getElementById('employeeTipoPago').value;
            const tarifa = parseInt(document.getElementById('employeeTarifa').value) || 5000;
            const salario = parseInt(document.getElementById('employeeSalario').value) || 1300000;
            const password = document.getElementById('employeePassword').value;
            
            try {
                if (uid) {
                    // Editar
                    await updateDoc(doc(db, 'users', uid), {
                        nombre,
                        email,
                        rol,
                        cargo,
                        tipo_pago: tipoPago,
                        tarifa_par: tarifa,
                        salario
                    });
                    showToast('Empleado actualizado correctamente', 'success');
                } else {
                    // Crear nuevo
                    if (!password || password.length < 6) {
                        showToast('La contrase√±a debe tener al menos 6 caracteres', 'warning');
                        return;
                    }
                    
                    // Crear usuario en Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Crear documento en Firestore
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        nombre,
                        email,
                        rol,
                        cargo,
                        tipo_pago: tipoPago,
                        tarifa_par: tarifa,
                        salario,
                        estado: 'activo',
                        fecha_creacion: Timestamp.now()
                    });
                    
                    showToast('Empleado creado correctamente', 'success');
                }
                
                closeModal();
                await loadEmployees();
                
            } catch (error) {
                console.error('Error guardando empleado:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    showToast('El correo ya est√° en uso', 'error');
                } else {
                    showToast('Error al guardar empleado', 'error');
                }
            }
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('passwordField').classList.remove('hidden');
        }

        // Cambiar pesta√±a
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('text-gray-400');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-purple-600', 'text-white');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-400');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
        }

        // Event Listeners
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            // B√∫squeda
            document.getElementById('searchEmployees').addEventListener('input', (e) => {
                renderEmployeesTable(e.target.value);
            });
            
            // Filtro de estado
            document.getElementById('filterStatus').addEventListener('change', () => {
                renderEmployeesTable(document.getElementById('searchEmployees').value);
            });
            
            // Modal
            document.getElementById('addEmployeeBtn').addEventListener('click', () => {
                document.getElementById('modalTitle').textContent = 'Nuevo Empleado';
                document.getElementById('employeeId').value = '';
                document.getElementById('employeeForm').reset();
                document.getElementById('passwordField').classList.remove('hidden');
                document.getElementById('employeeModal').classList.remove('hidden');
            });
            
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
            document.getElementById('employeeForm').addEventListener('submit', saveEmployee);
            
            // Asistencia
            document.getElementById('attendanceTime').addEventListener('change', (e) => {
                const [hours, minutes] = e.target.value.split(':');
                const late = parseInt(hours) > 7 || (parseInt(hours) === 7 && parseInt(minutes) > 0);
                document.getElementById('lateWarning').classList.toggle('hidden', !late);
            });
            
            document.getElementById('registerAttendanceBtn').addEventListener('click', registerAttendance);
            
            // Sanciones
            document.getElementById('applySanctionBtn').addEventListener('click', applySanction);
            
            // Toggle campos de pago
            document.getElementById('employeeTipoPago').addEventListener('change', (e) => {
                togglePaymentFields(e.target.value);
            });
        }

        // Iniciar
        init();
    </script>
</body>
</html>
