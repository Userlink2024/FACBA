<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - C&A Cloud Factory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-slide-out { animation: slide-out 0.3s ease-out; }
        .pulse-dot { animation: pulse-dot 2s infinite; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-slate-900">
    
    <!-- Navbar -->
    <nav class="bg-gray-800/90 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shoe-prints text-white"></i>
                    </div>
                    <span class="text-white font-bold text-lg hidden sm:block">C&A Cloud Factory</span>
                </div>

                <!-- Navigation -->
                <div id="navMenu" class="hidden md:flex items-center gap-2">
                    <!-- Dynamic menu items -->
                </div>

                <!-- User Menu -->
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p id="userName" class="text-white text-sm font-medium">-</p>
                        <p id="userRole" class="text-gray-400 text-xs">-</p>
                    </div>
                    <button 
                        id="logoutBtn"
                        class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition"
                        title="Cerrar Sesión"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white">
                <i class="fas fa-chart-line mr-3 text-blue-500"></i>
                Dashboard
            </h1>
            <p class="text-gray-400 mt-2">Resumen de producción y actividad en tiempo real</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Producción Hoy -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shoe-prints text-blue-500 text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-500">Hoy</span>
                </div>
                <p id="paresHoy" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Pares Producidos</p>
            </div>

            <!-- Producción Semana -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-emerald-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-calendar-week text-emerald-500 text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-500">Semana</span>
                </div>
                <p id="paresSemana" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Pares Esta Semana</p>
            </div>

            <!-- Órdenes Activas -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-amber-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clipboard-list text-amber-500 text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-500">Activas</span>
                </div>
                <p id="ordenesActivas" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Órdenes en Curso</p>
            </div>

            <!-- Operarios Conectados -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-purple-600/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-purple-500 text-xl"></i>
                    </div>
                    <span class="text-xs text-green-500 flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
                        En línea
                    </span>
                </div>
                <p id="operariosOnline" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Operarios Conectados</p>
            </div>
        </div>

        <!-- Charts & Lists Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Production Chart -->
            <div class="lg:col-span-2 bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-chart-bar mr-2 text-blue-500"></i>
                    Producción Diaria (Últimos 7 días)
                </h3>
                <div class="h-64">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>

            <!-- Online Workers -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-user-clock mr-2 text-green-500"></i>
                    Operarios en Línea
                </h3>
                <div id="onlineWorkersList" class="space-y-3 max-h-56 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sin operarios conectados</p>
                </div>
            </div>
        </div>

        <!-- Active Orders & Recent Production -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Active Orders -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-tasks mr-2 text-amber-500"></i>
                    Órdenes Activas
                </h3>
                <div id="activeOrdersList" class="space-y-3 max-h-80 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">No hay órdenes activas</p>
                </div>
            </div>

            <!-- Recent Production -->
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-history mr-2 text-blue-500"></i>
                    Producción Reciente
                </h3>
                <div id="recentProductionList" class="space-y-3 max-h-80 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sin registros recientes</p>
                </div>
            </div>
        </div>

        <!-- Notifications Panel (Admin only) -->
        <div id="notificationsPanel" class="hidden">
            <div class="bg-gradient-to-r from-blue-900/50 to-purple-900/50 backdrop-blur-sm rounded-xl border border-blue-700/50 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">
                        <i class="fas fa-bell mr-2 text-yellow-500"></i>
                        Notificaciones de Clientes
                        <span id="notifBadge" class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full hidden">0</span>
                    </h3>
                    <button id="clearNotifsBtn" class="text-gray-400 hover:text-white text-sm">
                        <i class="fas fa-check-double mr-1"></i>Marcar leídas
                    </button>
                </div>
                <div id="notificationsList" class="space-y-3 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">Sin notificaciones</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-600 text-sm">
                C&A Manufacturas 2024 - Bucaramanga, Colombia
            </p>
        </div>
    </footer>

    <script type="module">
        import { checkAuthAndRedirect, logout, ROLES } from './js/auth.js';
        import { initChat, openChat } from './js/chat.js';
        import { getNavigationMenu, getRoleName, getRoleBadgeColor } from './js/roles.js';
        import { formatCurrency, formatDateTime, formatDate, getWeekStart, getDayStart, getDayEnd } from './js/utils.js';
        import { db, rtdb, collection, query, where, orderBy, limit, getDocs, onSnapshot, Timestamp, ref, onValue, set } from './js/firebase-init.js';

        let productionChart = null;
        let lastNotifCount = -1; // -1 para ignorar la carga inicial
        let audioContext = null;
        let audioEnabled = false;
        
        // Inicializar audio con interacción del usuario
        function initAudio() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioEnabled = true;
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Activar audio con cualquier clic
        document.addEventListener('click', () => {
            initAudio();
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
        
        // Función para reproducir sonido de notificación
        function playNotificationSound() {
            if (!audioEnabled || !audioContext) {
                initAudio();
                if (!audioContext) return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Tono de notificación más audible
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(660, audioContext.currentTime + 0.15);
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Error playing sound:', e);
            }
        }

        // Inicializar
        async function init() {
            try {
                const { userData } = await checkAuthAndRedirect([ROLES.ADMIN_FINANZAS, ROLES.ADMIN_RRHH, ROLES.OPERARIO]);
                
                // Actualizar UI con datos del usuario
                document.getElementById('userName').textContent = userData.nombre;
                document.getElementById('userRole').textContent = getRoleName(userData.rol);
                
                // Generar menú de navegación
                generateNavMenu(userData.rol);
                
                // Cargar datos
                loadDashboardData(userData);
                
                // Inicializar chat
                initChat(userData.uid);
                
                // Escuchar presencia en tiempo real
                listenToPresence(userData.uid);
                
                // Mostrar notificaciones para admins
                if (userData.rol === ROLES.ADMIN_FINANZAS || userData.rol === ROLES.ADMIN_RRHH) {
                    document.getElementById('notificationsPanel').classList.remove('hidden');
                    listenToNotifications();
                }
                
            } catch (error) {
                console.error('Error de autenticación:', error);
            }
        }

        // Generar menú de navegación
        function generateNavMenu(rol) {
            const menu = getNavigationMenu(rol);
            const navMenu = document.getElementById('navMenu');
            
            navMenu.innerHTML = menu.map(item => `
                <a href="${item.href}" class="px-4 py-2 text-gray-300 hover:text-white hover:bg-gray-700/50 rounded-lg transition flex items-center gap-2 ${window.location.pathname.includes(item.href) ? 'bg-gray-700/50 text-white' : ''}">
                    <i class="fas ${item.icon}"></i>
                    <span>${item.name}</span>
                </a>
            `).join('');
        }

        // Cargar datos del dashboard
        async function loadDashboardData(userData) {
            const isOperario = userData.rol === ROLES.OPERARIO;
            
            // Cargar estadísticas
            await Promise.all([
                loadProductionStats(isOperario ? userData.uid : null),
                loadActiveOrders(),
                loadRecentProduction(isOperario ? userData.uid : null)
            ]);
            
            // Inicializar gráfica
            await initProductionChart(isOperario ? userData.uid : null);
        }

        // Cargar estadísticas de producción
        async function loadProductionStats(operarioUid = null) {
            try {
                const today = getDayStart();
                const weekStart = getWeekStart();
                
                // Query base
                let baseQuery = collection(db, 'produccion_logs');
                
                // Producción de hoy
                let todayQuery = query(
                    baseQuery,
                    where('fecha', '>=', Timestamp.fromDate(today))
                );
                
                if (operarioUid) {
                    todayQuery = query(
                        baseQuery,
                        where('uid_operario', '==', operarioUid),
                        where('fecha', '>=', Timestamp.fromDate(today))
                    );
                }
                
                const todaySnapshot = await getDocs(todayQuery);
                let paresHoy = 0;
                todaySnapshot.forEach(doc => {
                    paresHoy += doc.data().cantidad || 0;
                });
                document.getElementById('paresHoy').textContent = paresHoy;
                
                // Producción de la semana
                let weekQuery = query(
                    baseQuery,
                    where('fecha', '>=', Timestamp.fromDate(weekStart))
                );
                
                if (operarioUid) {
                    weekQuery = query(
                        baseQuery,
                        where('uid_operario', '==', operarioUid),
                        where('fecha', '>=', Timestamp.fromDate(weekStart))
                    );
                }
                
                const weekSnapshot = await getDocs(weekQuery);
                let paresSemana = 0;
                weekSnapshot.forEach(doc => {
                    paresSemana += doc.data().cantidad || 0;
                });
                document.getElementById('paresSemana').textContent = paresSemana;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Cargar órdenes activas
        async function loadActiveOrders() {
            try {
                const ordersQuery = query(
                    collection(db, 'ordenes'),
                    where('estado', '==', 'activa'),
                    orderBy('fecha_creacion', 'desc'),
                    limit(5)
                );
                
                const snapshot = await getDocs(ordersQuery);
                const ordersList = document.getElementById('activeOrdersList');
                const countEl = document.getElementById('ordenesActivas');
                
                countEl.textContent = snapshot.size;
                
                if (snapshot.empty) {
                    ordersList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay órdenes activas</p>';
                    return;
                }
                
                ordersList.innerHTML = '';
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const progress = Math.round((order.pares_hechos / order.cantidad_total) * 100) || 0;
                    
                    ordersList.innerHTML += `
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-white font-medium">${order.cliente}</p>
                                    <p class="text-gray-400 text-sm">${order.modelo}</p>
                                </div>
                                <span class="px-2 py-1 bg-amber-600/20 text-amber-400 text-xs rounded-full">
                                    ${order.pares_hechos}/${order.cantidad_total}
                                </span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-gray-500 text-xs mt-1">${progress}% completado</p>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Error cargando órdenes:', error);
            }
        }

        // Cargar producción reciente
        async function loadRecentProduction(operarioUid = null) {
            try {
                let recentQuery = query(
                    collection(db, 'produccion_logs'),
                    orderBy('fecha', 'desc'),
                    limit(10)
                );
                
                if (operarioUid) {
                    recentQuery = query(
                        collection(db, 'produccion_logs'),
                        where('uid_operario', '==', operarioUid),
                        orderBy('fecha', 'desc'),
                        limit(10)
                    );
                }
                
                const snapshot = await getDocs(recentQuery);
                const list = document.getElementById('recentProductionList');
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Sin registros recientes</p>';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const log = doc.data();
                    list.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-700/50 rounded-lg p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-600/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-shoe-prints text-blue-500"></i>
                                </div>
                                <div>
                                    <p class="text-white text-sm font-medium">${log.nombre_operario || 'Operario'}</p>
                                    <p class="text-gray-500 text-xs">${formatDateTime(log.fecha)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-white font-bold">${log.cantidad} pares</p>
                                <p class="text-emerald-400 text-sm">${formatCurrency(log.monto_ganado)}</p>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Error cargando producción reciente:', error);
            }
        }

        // Escuchar presencia en tiempo real
        function listenToPresence(currentUid) {
            const presenceRef = ref(rtdb, 'presence');
            
            onValue(presenceRef, (snapshot) => {
                const list = document.getElementById('onlineWorkersList');
                const countEl = document.getElementById('operariosOnline');
                
                if (!snapshot.exists()) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Sin operarios conectados</p>';
                    countEl.textContent = '0';
                    return;
                }
                
                const presence = snapshot.val();
                const onlineUsers = Object.entries(presence).filter(([uid, data]) => data.online && uid !== currentUid);
                
                countEl.textContent = onlineUsers.length;
                
                if (onlineUsers.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Sin operarios conectados</p>';
                    return;
                }
                
                list.innerHTML = onlineUsers.map(([uid, data]) => `
                    <div class="flex items-center gap-3 bg-gray-700/50 rounded-lg p-3 cursor-pointer hover:bg-gray-600/50 transition chat-user-btn" data-uid="${uid}" data-name="${data.nombre || 'Usuario'}">
                        <div class="relative">
                            <div class="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-700"></span>
                        </div>
                        <div class="flex-1">
                            <p class="text-white text-sm font-medium">${data.nombre || 'Usuario'}</p>
                            <p class="text-green-400 text-xs">En línea</p>
                        </div>
                        <i class="fas fa-comment text-blue-400 opacity-50"></i>
                    </div>
                `).join('');
                
                // Agregar evento de clic para abrir chat
                document.querySelectorAll('.chat-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        openChat(btn.dataset.uid, btn.dataset.name);
                    });
                });
            });
        }

        // Inicializar gráfica de producción
        async function initProductionChart(operarioUid = null) {
            try {
                // Obtener datos de los últimos 7 días
                const labels = [];
                const data = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dayStart = getDayStart(date);
                    const dayEnd = getDayEnd(date);
                    
                    labels.push(date.toLocaleDateString('es-CO', { weekday: 'short', day: 'numeric' }));
                    
                    let dayQuery = query(
                        collection(db, 'produccion_logs'),
                        where('fecha', '>=', Timestamp.fromDate(dayStart)),
                        where('fecha', '<=', Timestamp.fromDate(dayEnd))
                    );
                    
                    if (operarioUid) {
                        dayQuery = query(
                            collection(db, 'produccion_logs'),
                            where('uid_operario', '==', operarioUid),
                            where('fecha', '>=', Timestamp.fromDate(dayStart)),
                            where('fecha', '<=', Timestamp.fromDate(dayEnd))
                        );
                    }
                    
                    const snapshot = await getDocs(dayQuery);
                    let totalPares = 0;
                    snapshot.forEach(doc => {
                        totalPares += doc.data().cantidad || 0;
                    });
                    data.push(totalPares);
                }
                
                const ctx = document.getElementById('productionChart').getContext('2d');
                
                if (productionChart) {
                    productionChart.destroy();
                }
                
                productionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pares Producidos',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9CA3AF'
                                },
                                grid: {
                                    color: 'rgba(75, 85, 99, 0.3)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#9CA3AF'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error inicializando gráfica:', error);
            }
        }

        // Escuchar notificaciones en tiempo real
        function listenToNotifications() {
            // Escuchar desde Realtime Database para notificaciones instantáneas
            const notifsRef = ref(rtdb, 'notificaciones_fabrica');
            onValue(notifsRef, (snapshot) => {
                const list = document.getElementById('notificationsList');
                const badge = document.getElementById('notifBadge');
                
                if (!snapshot.exists()) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Sin notificaciones</p>';
                    badge.classList.add('hidden');
                    return;
                }
                
                const notifs = [];
                snapshot.forEach(child => {
                    notifs.push({ id: child.key, ...child.val() });
                });
                
                // Ordenar por fecha descendente
                notifs.sort((a, b) => (b.fecha || 0) - (a.fecha || 0));
                
                const unread = notifs.filter(n => !n.leido).length;
                
                // Reproducir sonido si hay nuevas notificaciones (ignorar carga inicial)
                if (unread > lastNotifCount && lastNotifCount >= 0) {
                    playNotificationSound();
                }
                // Después de la primera carga, empezar a contar
                if (lastNotifCount === -1) {
                    lastNotifCount = unread;
                } else {
                    lastNotifCount = unread;
                }
                
                if (unread > 0) {
                    badge.textContent = unread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                list.innerHTML = notifs.slice(0, 10).map(notif => {
                    const fecha = notif.fecha ? new Date(notif.fecha).toLocaleString('es-CO') : '';
                    const isNew = !notif.leido;
                    const iconClass = notif.tipo === 'nuevo_pedido' ? 'fa-box text-blue-500' : 
                                     notif.tipo === 'nuevo_cliente' ? 'fa-user-plus text-green-500' : 'fa-bell text-yellow-500';
                    
                    return `
                        <div class="flex items-start gap-3 p-3 rounded-lg ${isNew ? 'bg-blue-900/30 border border-blue-700/50' : 'bg-gray-700/30'}" data-id="${notif.id}">
                            <div class="w-10 h-10 bg-gray-700 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-medium text-sm">${notif.titulo || 'Notificación'}</p>
                                <p class="text-gray-400 text-xs mt-1">${notif.mensaje || ''}</p>
                                <p class="text-gray-500 text-xs mt-1">${fecha}</p>
                            </div>
                            ${isNew ? '<span class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></span>' : ''}
                        </div>
                    `;
                }).join('');
            });
            
            // Marcar todas como leídas
            document.getElementById('clearNotifsBtn').addEventListener('click', async () => {
                const notifsRef = ref(rtdb, 'notificaciones_fabrica');
                onValue(notifsRef, (snapshot) => {
                    snapshot.forEach(child => {
                        const updateRef = ref(rtdb, `notificaciones_fabrica/${child.key}/leido`);
                        set(updateRef, true);
                    });
                }, { onlyOnce: true });
            });
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await logout();
        });

        // Iniciar
        init();
    </script>
</body>
</html>
