<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario y Facturación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
        }
        .module {
            display: none; /* Ocultar módulos por defecto */
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            cursor: pointer; /* Añadir cursor pointer */
        }
        .btn-primary {
            background-color: #3b82f6; /* Azul */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Azul más oscuro al pasar el ratón */
        }
         .btn-danger {
            background-color: #ef4444; /* Rojo */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Rojo más oscuro al pasar el ratón */
        }
         .btn-sm {
             padding: 5px 10px; /* Padding más pequeño para botones en tabla */
             font-size: 0.875rem; /* Tamaño de fuente más pequeño */
         }
        .form-input {
            padding: 8px;
            border: 1px solid #d1d5db; /* Gris */
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal {
             display: none; /* Ocultar modal por defecto */
             position: fixed; /* Posición fija */
             z-index: 1000; /* Estar por encima de otros elementos */
             left: 0;
             top: 0;
             width: 100%; /* Ancho completo */
             height: 100%; /* Alto completo */
             overflow: auto; /* Habilitar scroll si es necesario */
             background-color: rgba(0, 0, 0, 0.4); /* Fondo oscuro semi-transparente */
        }
        .modal-content {
             background-color: #fefefe;
             margin: 15% auto; /* 15% desde arriba y centrado horizontalmente */
             padding: 20px;
             border: 1px solid #888;
             width: 80%; /* Podrías ajustar esto */
             max-width: 500px; /* Ancho máximo */
             border-radius: 8px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4">

    <div class="container mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6">Sistema de Inventario y Facturación</h1>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="btnInventario" class="btn btn-primary">Ver Inventarios</button>
            <button id="btnFacturacion" class="btn btn-primary">Abrir Módulo Facturación</button>
            <button id="btnVerFacturas" class="btn btn-primary">Ver Facturas</button> </div>

        <div id="moduloInventario" class="module card">
            <h2 class="text-xl font-semibold mb-4">Gestión de Inventario</h2>

            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3" id="formInventarioTitle">Agregar Producto</h3>
                <form id="formInventario" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="invProductId">
                    <div>
                        <label for="invFechaHora" class="form-label">Fecha:</label>
                        <input type="date" id="invFechaHora" class="form-input bg-gray-100" required>
                    </div>
                    <div>
                        <label for="invReferencia" class="form-label">Referencia:</label>
                        <input type="text" id="invReferencia" class="form-input" required>
                    </div>
                    <div>
                        <label for="invColor" class="form-label">Color:</label>
                        <input type="text" id="invColor" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label mb-2">Unidad de Medida:</label>
                        <div class="flex items-center space-x-4">
                            <label>
                                <input type="radio" name="unidadMedida" value="metros" id="radioMetros" class="mr-1" required>
                                Metros con Centímetros
                            </label>
                            <label>
                                <input type="radio" name="unidadMedida" value="unidades" id="radioUnidades" class="mr-1" required>
                                Unidades
                            </label>
                        </div>
                    </div>

                    <div id="camposMetros" class="grid grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="invMetros" class="form-label">Metros:</label>
                            <input type="number" id="invMetros" class="form-input" min="0" value="0">
                        </div>
                        <div>
                            <label for="invCentimetros" class="form-label">Centímetros:</label>
                            <input type="number" id="invCentimetros" class="form-input" min="0" max="99" value="0">
                        </div>
                    </div>

                    <div id="camposUnidades" class="hidden">
                         <div>
                            <label for="invUnidades" class="form-label">Unidades:</label>
                            <input type="number" id="invUnidades" class="form-input" min="0" value="0">
                         </div>
                    </div>

                     <div>
                        <label for="invValor" class="form-label">Valor:</label>
                        <input type="number" id="invValor" class="form-input" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label for="invProveedor" class="form-label">Proveedor de China:</label>
                        <input type="text" id="invProveedor" class="form-input">
                    </div>

                    <div class="md:col-span-2 flex justify-end space-x-2">
                         <button type="button" id="btnCancelarEdicion" class="btn btn-danger hidden">Cancelar Edición</button>
                        <button type="submit" class="btn btn-primary">Guardar Producto</button>
                    </div>
                </form>
            </div>

            <div>
                <h3 class="text-lg font-medium mb-3">Lista de Inventario</h3>
                <div class="mb-4">
                    <label for="inputBuscarInventario" class="form-label">Buscar en Inventario:</label>
                    <input type="text" id="inputBuscarInventario" class="form-input" placeholder="Buscar por Referencia o Color...">
                </div>
                <div class="overflow-x-auto">
                    <table id="tablaInventario" class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 border-b text-left">Fecha</th>
                                <th class="px-4 py-2 border-b text-left">Referencia</th>
                                <th class="px-4 py-2 border-b text-left">Color</th>
                                <th class="px-4 py-2 border-b text-left">Cantidad</th>
                                <th class="px-4 py-2 border-b text-left">Valor</th>
                                <th class="px-4 py-2 border-b text-left">Proveedor</th>
                                <th class="px-4 py-2 border-b text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center py-4">Cargando inventario...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="btnExportarInventario" class="btn btn-primary">Exportar Inventario</button>
                </div>
            </div>
        </div>

        <div id="moduloFacturacion" class="module card">
            <h2 class="text-xl font-semibold mb-4">Crear Factura</h2>

            <form id="formFacturacion" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <input type="hidden" id="facProductId">
                 <input type="hidden" id="facProductUnit">
                 <input type="hidden" id="facProductMetros">
                 <input type="hidden" id="facProductCentimetros">
                 <input type="hidden" id="facProductUnidades">
                 <div>
                    <label for="facFechaHora" class="form-label">Fecha:</label>
                     <input type="date" id="facFechaHora" class="form-input bg-gray-100" required>
                </div>
                <div>
                    <label for="facCliente" class="form-label">Cliente:</label>
                    <input type="text" id="facCliente" class="form-input" required>
                </div>
                <div class="md:col-span-2">
                    <label for="facProducto" class="form-label">Producto:</label>
                    <input type="text" id="facProducto" class="form-input" placeholder="Buscar producto en inventario..." readonly required>
                    <button id="btnBuscarProducto" type="button" class="btn btn-primary mt-2">Buscar Producto</button>
                    <div id="detalleProductoFactura" class="mt-3 p-3 border rounded hidden">
                        <p><strong>Producto Seleccionado:</strong> <span id="prodNombreFac"></span></p>
                        <p><strong>Cantidad Disponible:</strong> <span id="prodCantidadFac"></span></p>
                        <div id="camposDescuentoMetros" class="grid grid-cols-2 gap-4 mt-2 hidden">
                            <div>
                                <label for="descMetros" class="form-label">Metros a Descontar:</label>
                                <input type="number" id="descMetros" class="form-input" min="0" value="0" required>
                            </div>
                            <div>
                                <label for="descCentimetros" class="form-label">Centímetros a Descontar:</label>
                                <input type="number" id="descCentimetros" class="form-input" min="0" max="99" value="0" required>
                            </div>
                        </div>
                         <div id="camposDescuentoUnidades" class="mt-2 hidden">
                             <div>
                                <label for="descUnidades" class="form-label">Unidades:</label>
                                <input type="number" id="descUnidades" class="form-input" min="0" value="0" required>
                             </div>
                         </div>
                    </div>
                </div>

                <div>
                    <label for="facValor" class="form-label">Valor Total:</label>
                    <input type="number" id="facValor" class="form-input" min="0" step="0.01" required>
                </div>

                 <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn btn-primary">Crear Factura</button>
                </div>
            </form>

            </div>

        <div id="moduloVerFacturas" class="module card">
            <h2 class="text-xl font-semibold mb-4">Facturas Emitidas</h2>

            <div>
                <h3 class="text-lg font-medium mb-3">Lista de Facturas</h3>
                <div class="overflow-x-auto">
                    <table id="tablaFacturas" class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 border-b text-left">Fecha</th>
                                <th class="px-4 py-2 border-b text-left">Cliente</th>
                                <th class="px-4 py-2 border-b text-left">Producto</th>
                                <th class="px-4 py-2 border-b text-left">Cantidad</th>
                                <th class="px-4 py-2 border-b text-left">Valor Total</th>
                                <th class="px-4 py-2 border-b text-left">Acciones</th> </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center py-4">Cargando facturas...</td> </tr>
                        </tbody>
                    </table>
                </div>
                 <div class="mt-4 flex justify-end space-x-2">
                    <button id="btnExportarFacturas" class="btn btn-primary">Exportar Facturas</button> </div>
            </div>
        </div>


        <div id="moduloBuscarProducto" class="modal">
            <div class="modal-content">
                 <span class="close-button" id="cerrarBuscarProducto">&times;</span>
                <h3 class="text-lg font-medium mb-4">Buscar Producto en Inventario</h3>
                <input type="text" id="inputBuscarProducto" class="form-input mb-4" placeholder="Escribe para buscar...">
                <div id="resultadosBusqueda" class="border rounded max-h-40 overflow-y-auto">
                    <p class="text-center py-2">Escribe para buscar...</p>
                </div>
            </div>
        </div>

         <div id="statusMessage" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded shadow-lg hidden">
             Mensaje de estado
         </div>

    </div>

    <script type="module">
        console.log('DEBUG: Script module iniciado.');

        // Importar las funciones necesarias de Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // Opcional si no usas Analytics
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
            authDomain: "lazapateria-ce24f.firebaseapp.com",
            projectId: "lazapateria-ce24f",
            storageBucket: "lazapateria-ce24f.firebaseapp.com",
            messagingSenderId: "642571845821",
            appId: "1:642571845821:web:45858a0abc0df728fd77d4",
            measurementId: "G-6JCF33H0K1" // Opcional
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app); // Opcional
        const db = getFirestore(app); // Usaremos Firestore

        // --- Elementos del DOM ---
        console.log('DEBUG: Obteniendo referencias a elementos del DOM...');
        const btnInventario = document.getElementById('btnInventario');
        const btnFacturacion = document.getElementById('btnFacturacion');
        const btnVerFacturas = document.getElementById('btnVerFacturas');
        const moduloInventario = document.getElementById('moduloInventario');
        const moduloFacturacion = document.getElementById('moduloFacturacion');
        const moduloVerFacturas = document.getElementById('moduloVerFacturas');
        const formInventario = document.getElementById('formInventario');
        const formInventarioTitle = document.getElementById('formInventarioTitle');
        const invProductId = document.getElementById('invProductId');
        const radioMetros = document.getElementById('radioMetros');
        const radioUnidades = document.getElementById('radioUnidades');
        const camposMetros = document.getElementById('camposMetros');
        const camposUnidades = document.getElementById('camposUnidades');
        const invFechaHora = document.getElementById('invFechaHora');
        const invReferencia = document.getElementById('invReferencia');
        const invColor = document.getElementById('invColor');
        const invMetros = document.getElementById('invMetros');
        const invCentimetros = document.getElementById('invCentimetros');
        const invUnidades = document.getElementById('invUnidades');
        const invValor = document.getElementById('invValor');
        const invProveedor = document.getElementById('invProveedor');
        const btnCancelarEdicion = document.getElementById('btnCancelarEdicion');
        const tablaInventario = document.getElementById('tablaInventario').querySelector('tbody');
        const inputBuscarInventario = document.getElementById('inputBuscarInventario'); // Nuevo input de búsqueda de inventario
        const btnExportarInventario = document.getElementById('btnExportarInventario');
        const formFacturacion = document.getElementById('formFacturacion');
        const facFechaHora = document.getElementById('facFechaHora');
        const facCliente = document.getElementById('facCliente');
        const facProducto = document.getElementById('facProducto');
        const btnBuscarProducto = document.getElementById('btnBuscarProducto');
        const detalleProductoFactura = document.getElementById('detalleProductoFactura');
        const prodNombreFac = document.getElementById('prodNombreFac');
        const prodCantidadFac = document.getElementById('prodCantidadFac');
        const camposDescuentoMetros = document.getElementById('camposDescuentoMetros');
        const camposDescuentoUnidades = document.getElementById('camposDescuentoUnidades');
        const descMetros = document.getElementById('descMetros');
        const descCentimetros = document.getElementById('descCentimetros');
        const descUnidades = document.getElementById('descUnidades');
        const facValor = document.getElementById('facValor');
        const facProductId = document.getElementById('facProductId');
        const facProductUnit = document.getElementById('facProductUnit');
        const facProductMetros = document.getElementById('facProductMetros');
        const facProductCentimetros = document.getElementById('facProductCentimetros');
        const facProductUnidades = document.getElementById('facProductUnidades');
        const moduloBuscarProducto = document.getElementById('moduloBuscarProducto');
        const cerrarBuscarProducto = document.getElementById('cerrarBuscarProducto');
        const inputBuscarProducto = document.getElementById('inputBuscarProducto');
        const resultadosBusqueda = document.getElementById('resultadosBusqueda');
        const statusMessage = document.getElementById('statusMessage');
        const tablaFacturas = document.getElementById('tablaFacturas').querySelector('tbody');
        const btnExportarFacturas = document.getElementById('btnExportarFacturas');


        console.log('DEBUG: invFechaHora al obtener referencia:', invFechaHora);
        console.log('DEBUG: facFechaHora al obtener referencia:', facFechaHora);
        console.log('DEBUG: btnVerFacturas al obtener referencia:', btnVerFacturas);
        console.log('DEBUG: moduloVerFacturas al obtener referencia:', moduloVerFacturas);
        console.log('DEBUG: btnExportarFacturas al obtener referencia:', btnExportarFacturas);
        console.log('DEBUG: inputBuscarInventario al obtener referencia:', inputBuscarInventario);


        // --- Funciones de Utilidad ---

         function showStatusMessage(message, isError = false) {
             statusMessage.textContent = message;
             statusMessage.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
             if (isError) {
                 statusMessage.classList.add('bg-red-500');
             } else {
                 statusMessage.classList.add('bg-green-500');
             }
             setTimeout(() => {
                 statusMessage.classList.add('hidden');
             }, 3000);
         }


        function mostrarModulo(moduloAMostrar) {
             try {
                moduloInventario.style.display = 'none';
                moduloFacturacion.style.display = 'none';
                moduloVerFacturas.style.display = 'none';
                moduloBuscarProducto.style.display = 'none';

                moduloAMostrar.style.display = 'block';

                if (moduloAMostrar === moduloInventario) {
                    console.log('DEBUG: Mostrando Módulo Inventario.');
                    resetFormInventario();
                    cargarInventario();
                } else if (moduloAMostrar === moduloFacturacion) {
                    console.log('DEBUG: Mostrando Módulo Facturación.');
                    resetFormFacturacion();
                } else if (moduloAMostrar === moduloVerFacturas) {
                     console.log('DEBUG: Mostrando Módulo Ver Facturas.');
                     cargarFacturas();
                }
             } catch (error) {
                 console.error("Error en mostrarModulo:", error);
                 showStatusMessage("Error interno al cambiar de módulo.", true);
             }
        }

        function handleUnidadMedida() {
            if (radioMetros.checked) {
                camposMetros.classList.remove('hidden');
                camposUnidades.classList.add('hidden');
                 invMetros.setAttribute('required', 'required');
                 invCentimetros.setAttribute('required', 'required');
                 invUnidades.removeAttribute('required');
                 invUnidades.value = 0;
            } else if (radioUnidades.checked) {
                camposMetros.classList.add('hidden');
                camposUnidades.classList.remove('hidden');
                 invUnidades.setAttribute('required', 'required');
                 invMetros.removeAttribute('required');
                 invCentimetros.removeAttribute('required');
                 invMetros.value = 0;
                 invCentimetros.value = 0;
            }
             if (!radioMetros.checked && !radioUnidades.checked) {
             }
        }

         function handleCamposDescuento(unidad) {
             camposDescuentoMetros.classList.add('hidden');
             camposDescuentoUnidades.classList.add('hidden');

             descMetros.removeAttribute('required');
             descCentimetros.removeAttribute('required');
             descUnidades.removeAttribute('required');

             descMetros.value = 0;
             descCentimetros.value = 0;
             descUnidades.value = 0;


             if (unidad === 'metros') {
                 camposDescuentoMetros.classList.remove('hidden');
                 descMetros.setAttribute('required', 'required');
                 descCentimetros.setAttribute('required', 'required');
             } else if (unidad === 'unidades') {
                 camposDescuentoUnidades.classList.remove('hidden');
                 descUnidades.setAttribute('required', 'required');
             }
         }

         function resetFormInventario() {
             formInventario.reset();
             invProductId.value = '';
             formInventarioTitle.textContent = 'Agregar Producto';
             btnCancelarEdicion.classList.add('hidden');
             camposMetros.classList.add('hidden');
             camposUnidades.classList.add('hidden');
             radioMetros.checked = false;
             radioUnidades.checked = false;
             handleUnidadMedida();
             if(invFechaHora) invFechaHora.value = '';
             if(inputBuscarInventario) inputBuscarInventario.value = ''; // Limpiar búsqueda al resetear
             filtrarInventario(); // Aplicar filtro vacío
         }

         function resetFormFacturacion() {
             formFacturacion.reset();
             facProductId.value = '';
             facProductUnit.value = '';
             facProductMetros.value = '';
             facProductCentimetros.value = '';
             facProductUnidades.value = '';
             detalleProductoFactura.classList.add('hidden');
             handleCamposDescuento('');
             if(facFechaHora) facFechaHora.value = '';
         }


        // --- Lógica de Firebase ---

        const inventarioCol = collection(db, "inventario");
        const facturasCol = collection(db, "facturas");


        // Función para cargar inventario desde Firebase en tiempo real
        function cargarInventario() {
            tablaInventario.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando inventario...</td></tr>';

            onSnapshot(inventarioCol, (snapshot) => {
                tablaInventario.innerHTML = '';

                if (snapshot.empty) {
                    tablaInventario.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay productos en el inventario.</td></tr>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const producto = doc.data();
                    const row = tablaInventario.insertRow();
                    row.dataset.id = doc.id; // Guardar ID en la fila para filtrado

                    let cantidadDisplay = '';
                    if (producto.unidadMedida === 'metros') {
                         const metros = producto.metros || 0;
                         const centimetros = producto.centimetros || 0;
                         cantidadDisplay = `${metros}.${centimetros.toString().padStart(2, '0')} Metros`;
                    } else if (producto.unidadMedida === 'unidades') {
                        cantidadDisplay = `${producto.unidades || 0} Unidades`;
                    }

                    row.innerHTML = `
                        <td class="px-4 py-2 border-b">${producto.fechaHora}</td>
                        <td class="px-4 py-2 border-b">${producto.referencia}</td>
                        <td class="px-4 py-2 border-b">${producto.color}</td>
                        <td class="px-4 py-2 border-b">${cantidadDisplay}</td>
                        <td class="px-4 py-2 border-b">${parseFloat(producto.valor).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td> <td class="px-4 py-2 border-b">${producto.proveedor || ''}</td>
                        <td class="px-4 py-2 border-b">
                            <button class="btn btn-primary btn-sm mr-2" data-id="${doc.id}" onclick="window.modificarProducto('${doc.id}')">Modificar</button>
                            <button class="btn btn-danger btn-sm" data-id="${doc.id}" onclick="window.eliminarProducto('${doc.id}')">Eliminar</button>
                        </td>
                    `;
                     // Guardar cantidadDisplay en el objeto producto para usarlo si se modifica
                     producto.cantidadDisplay = cantidadDisplay;
                });

                 filtrarInventario(); // Aplicar el filtro inicial después de cargar
            }, (error) => {
                console.error("Error cargando inventario:", error);
                tablaInventario.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar inventario.</td></tr>';
                showStatusMessage("Error al cargar inventario.", true);
            });
        }

        // Función para filtrar la tabla de inventario
        function filtrarInventario() {
            const searchTerm = inputBuscarInventario.value.toLowerCase().trim();
            const rows = tablaInventario.querySelectorAll("tr");

            rows.forEach(row => {
                // Saltar la fila de "Cargando inventario..." o "No hay productos..."
                if (row.querySelector('td[colspan="7"]')) {
                    return;
                }

                const referencia = row.cells[1].textContent.toLowerCase(); // Columna Referencia
                const color = row.cells[2].textContent.toLowerCase();      // Columna Color

                if (referencia.includes(searchTerm) || color.includes(searchTerm)) {
                    row.style.display = ''; // Mostrar fila si coincide
                } else {
                    row.style.display = 'none'; // Ocultar fila si no coincide
                }
            });
        }


        // Función para cargar facturas desde Firebase en tiempo real
        function cargarFacturas() {
             tablaFacturas.innerHTML = '<tr><td colspan="6" class="text-center py-4">Cargando facturas...</td></tr>'; // Ajustar colspan

             onSnapshot(facturasCol, (snapshot) => {
                 tablaFacturas.innerHTML = ''; // Limpiar tabla

                 if (snapshot.empty) {
                     tablaFacturas.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay facturas emitidas.</td></tr>'; // Ajustar colspan
                     return;
                 }

                 snapshot.forEach((doc) => {
                     const factura = doc.data();
                     const row = tablaFacturas.insertRow();

                     let cantidadFacturadaDisplay = '';
                     if (factura.producto && factura.producto.unidadMedida === 'metros') {
                          const metros = factura.producto.metrosFacturados || 0;
                          const centimetros = factura.producto.centimetrosFacturados || 0;
                          cantidadFacturadaDisplay = `${metros}.${centimetros.toString().padStart(2, '0')} Metros`;
                     } else if (factura.producto && factura.producto.unidadMedida === 'unidades') {
                         cantidadFacturadaDisplay = `${factura.producto.unidadesFacturadas || 0} Unidades`;
                     } else {
                         cantidadFacturadaDisplay = 'N/A';
                     }

                     row.innerHTML = `
                         <td class="px-4 py-2 border-b">${factura.fechaHora}</td>
                         <td class="px-4 py-2 border-b">${factura.cliente}</td>
                         <td class="px-4 py-2 border-b">${factura.producto ? factura.producto.referencia + ' - ' + factura.producto.color : 'Producto Desconocido'}</td>
                         <td class="px-4 py-2 border-b">${cantidadFacturadaDisplay}</td>
                         <td class="px-4 py-2 border-b">${parseFloat(factura.valorTotal).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td> <td class="px-4 py-2 border-b">
                             <button class="btn btn-danger btn-sm" data-id="${doc.id}" onclick="window.eliminarFactura('${doc.id}')">Eliminar</button>
                         </td>
                     `;
                 });
             }, (error) => {
                 console.error("Error cargando facturas:", error);
                 tablaFacturas.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar facturas.</td></tr>'; // Ajustar colspan
                 showStatusMessage("Error al cargar facturas.", true);
             });
        }

        // Función para eliminar factura en Firebase
        async function eliminarFactura(idFactura) {
            if (confirm("¿Estás seguro de eliminar esta factura?")) {
                try {
                    await deleteDoc(doc(db, "facturas", idFactura));
                    showStatusMessage("Factura eliminada con éxito.");
                } catch (error) {
                    console.error("Error al eliminar factura:", error);
                    showStatusMessage("Error al eliminar la factura.", true);
                }
            }
        }

        // Exponer la función al ámbito global
        window.eliminarFactura = eliminarFactura;


        // Función para exportar facturas a Excel (CSV)
        function exportarFacturasAExcel() {
            console.log('DEBUG: Iniciando exportación de facturas a Excel.');
            let csvContent = "data:text/csv;charset=utf-8,";

            // Encabezados del CSV
            const headers = ["Fecha", "Cliente", "Producto", "Cantidad", "Valor Total"];
            csvContent += headers.join(";") + "\r\n"; // Usar ; como separador

            // Datos de la tabla
            const rows = tablaFacturas.querySelectorAll("tr");

            rows.forEach(function(row) {
                // Saltar la fila de "Cargando facturas..." o "No hay facturas..."
                if (row.querySelector('td[colspan="6"]')) { // Ajustar colspan
                    return;
                }

                let rowData = [];
                // Seleccionar solo las celdas de datos (excluir encabezados si se ejecuta después de cargar)
                row.querySelectorAll("td").forEach(function(cell, index) {
                     // Excluir la última celda que contiene el botón de eliminar
                     if (index < row.cells.length - 1) {
                        rowData.push(cell.textContent.trim());
                     }
                });
                csvContent += rowData.join(";") + "\r\n";
            });

            // Crear enlace de descarga
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "facturas.csv");
            document.body.appendChild(link); // Requerido para algunos navegadores como Firefox
            link.click(); // Simular clic para descargar
            document.body.removeChild(link); // Limpiar el enlace

            showStatusMessage("Facturas exportadas a facturas.csv");
            console.log('DEBUG: Exportación de facturas completada.');
        }


        async function productoExiste(referencia, color, excludeId = null) {
            const q = query(inventarioCol, where("referencia", "==", referencia), where("color", "==", color));
            const snapshot = await getDocs(q);

            if (excludeId) {
                 return snapshot.docs.some(doc => doc.id !== excludeId);
            } else {
                 return !snapshot.empty;
            }
        }


        async function guardarProducto(event) {
            event.preventDefault();

            const id = invProductId.value;
            const referencia = invReferencia.value.trim().toLowerCase();
            const color = invColor.value.trim().toLowerCase();
            const valor = parseFloat(invValor.value);
            const proveedor = invProveedor.value.trim();
            const fechaHora = invFechaHora.value.trim();

            if (!fechaHora) {
                 showStatusMessage("La fecha es obligatoria.", true);
                 return;
            }


            let unidad = '';
            let metros = 0;
            let centimetros = 0;
            let unidades = 0;

            if (radioMetros.checked) {
                unidad = 'metros';
                metros = parseInt(invMetros.value) || 0;
                centimetros = parseInt(invCentimetros.value) || 0;
                 if (metros === 0 && centimetros === 0) {
                     showStatusMessage("La cantidad en metros o centímetros debe ser mayor a 0.", true);
                     return;
                 }
            } else if (radioUnidades.checked) {
                unidad = 'unidades';
                unidades = parseInt(invUnidades.value) || 0;
                 if (unidades === 0) {
                     showStatusMessage("La cantidad en unidades debe ser mayor a 0.", true);
                     return;
                 }
            } else {
                 showStatusMessage("Debe seleccionar una unidad de medida.", true);
                 return;
            }

            if (!id && await productoExiste(referencia, color)) {
                showStatusMessage(`El producto con referencia "${referencia}" y color "${color}" ya existe.`, true);
                return;
            }

             if (id && await productoExiste(referencia, color, id)) {
                 showStatusMessage(`Ya existe otro producto con referencia "${referencia}" y color "${color}".`, true);
                 return;
             }

            const productoData = {
                fechaHora: fechaHora,
                referencia: referencia,
                color: color,
                unidadMedida: unidad,
                metros: metros,
                centimetros: centimetros,
                unidades: unidades,
                valor: valor, // Guardar el valor numérico sin formato
                proveedor: proveedor
            };

            try {
                if (id) {
                    const productRef = doc(db, "inventario", id);
                    await updateDoc(productRef, productoData);
                    showStatusMessage("Producto actualizado con éxito!");
                } else {
                    await addDoc(inventarioCol, productoData);
                    showStatusMessage("Producto guardado con éxito!");
                }
                resetFormInventario();
            } catch (e) {
                console.error("Error al guardar el producto: ", e);
                showStatusMessage("Error al guardar el producto.", true);
            }
        }

        async function eliminarProducto(idProducto) {
            if (confirm("¿Estás seguro de eliminar este producto?")) {
                try {
                    await deleteDoc(doc(db, "inventario", idProducto));
                    showStatusMessage("Producto eliminado con éxito.");
                } catch (error) {
                    console.error("Error al eliminar documento:", error);
                    showStatusMessage("Error al eliminar el producto.", true);
                }
            }
        }

        async function modificarProducto(idProducto) {
             try {
                 const productRef = doc(db, "inventario", idProducto);
                 const productSnap = await getDoc(productRef);

                 if (productSnap.exists()) {
                     const producto = productSnap.data();
                     invProductId.value = idProducto;
                     invFechaHora.value = producto.fechaHora;
                     invReferencia.value = producto.referencia;
                     invColor.value = producto.color;
                     invValor.value = producto.valor; // Cargar el valor numérico
                     invProveedor.value = producto.proveedor || '';

                     if (producto.unidadMedida === 'metros') {
                         radioMetros.checked = true;
                         invMetros.value = producto.metros || 0;
                         invCentimetros.value = producto.centimetros || 0;
                     } else if (producto.unidadMedida === 'unidades') {
                         radioUnidades.checked = true;
                         invUnidades.value = producto.unidades || 0;
                     }
                     handleUnidadMedida();

                     formInventarioTitle.textContent = 'Modificar Producto';
                     btnCancelarEdicion.classList.remove('hidden');
                     formInventario.scrollIntoView({ behavior: 'smooth' });

                 } else {
                     showStatusMessage("Producto no encontrado para modificar.", true);
                 }
             } catch (error) {
                 console.error("Error cargando datos para modificar:", error);
                 showStatusMessage("Error cargando datos para modificar.", true);
             }
        }

        window.modificarProducto = modificarProducto;
        window.eliminarProducto = eliminarProducto;


        function exportarInventarioAExcel() {
             showStatusMessage("Funcionalidad de Exportar Inventario a Excel pendiente.");
             // Implementación real requeriría una librería como SheetJS (xlsx) o similar
        }


        // Función para buscar producto en Firebase para facturación
        async function buscarProductoParaFacturacion() {
            console.log('DEBUG: Iniciando búsqueda de producto para facturación...');
            const searchTerm = inputBuscarProducto.value.toLowerCase().trim();
            resultadosBusqueda.innerHTML = '';

            console.log('DEBUG: Término de búsqueda (en minúsculas):', searchTerm);

             if (searchTerm.length < 2) {
                 resultadosBusqueda.innerHTML = '<p class="text-center py-2">Escribe al menos 2 caracteres para buscar.</p>';
                 console.log('DEBUG: Término de búsqueda demasiado corto.');
                 return;
             }

             try {
                 const qRef = query(inventarioCol, where("referencia", ">=", searchTerm), where("referencia", "<=", searchTerm + '\uf8ff'));
                 const qColor = query(inventarioCol, where("color", ">=", searchTerm), where("color", "<=", searchTerm + '\uf8ff'));

                 console.log('DEBUG: Ejecutando consultas a Firestore...');
                 console.log('DEBUG: Consulta Referencia:', qRef);
                 console.log('DEBUG: Consulta Color:', qColor);


                 const [snapshotRef, snapshotColor] = await Promise.all([getDocs(qRef), getDocs(qColor)]);

                 console.log('DEBUG: Consultas ejecutadas. snapshotRef:', snapshotRef.docs.length, 'resultados. snapshotColor:', snapshotColor.docs.length, 'resultados.');
                 console.log('DEBUG: Documentos de snapshotRef:', snapshotRef.docs.map(doc => doc.data()));
                 console.log('DEBUG: Documentos de snapshotColor:', snapshotColor.docs.map(doc => doc.data()));


                 const resultados = new Map();

                 snapshotRef.forEach(doc => resultados.set(doc.id, { id: doc.id, ...doc.data() }));
                 snapshotColor.forEach(doc => resultados.set(doc.id, { id: doc.id, ...doc.data() }));

                 console.log('DEBUG: Total de resultados únicos encontrados:', resultados.size);
                 console.log('DEBUG: Resultados combinados:', Array.from(resultados.values()));


                 if (resultados.size === 0) {
                     resultadosBusqueda.innerHTML = '<p class="text-center py-2">No se encontraron productos.</p>';
                     console.log('DEBUG: No se encontraron productos.');
                     return;
                 }

                 resultados.forEach(producto => {
                     const resultadoDiv = document.createElement('div');
                     resultadoDiv.classList.add('p-2', 'border-b', 'cursor-pointer', 'hover:bg-gray-100');

                     let cantidadDisplay = '';
                     if (producto.unidadMedida === 'metros') {
                          const metros = producto.metros || 0;
                          const centimetros = producto.centimetros || 0;
                          cantidadDisplay = `${metros}.${centimetros.toString().padStart(2, '0')} Metros`;
                     } else if (producto.unidadMedida === 'unidades') {
                         cantidadDisplay = `${producto.unidades || 0} Unidades`;
                     }

                     resultadoDiv.textContent = `${producto.referencia} - ${producto.color} (${cantidadDisplay})`;
                     resultadoDiv.onclick = () => seleccionarProductoParaFactura(producto);
                     resultadosBusqueda.appendChild(resultadoDiv);
                 });
                 console.log('DEBUG: Resultados de búsqueda mostrados.');

             } catch (error) {
                 console.error("Error buscando producto:", error);
                 resultadosBusqueda.innerHTML = '<p class="text-center py-2 text-red-500">Error buscando productos.</p>';
                 showStatusMessage("Error buscando productos.", true);
             }
        }

        function seleccionarProductoParaFactura(producto) {
            console.log("DEBUG: Producto seleccionado para factura:", producto);
            moduloBuscarProducto.style.display = 'none';

            facProductId.value = producto.id;
            facProductUnit.value = producto.unidadMedida;
            facProductMetros.value = producto.metros || 0;
            facProductCentimetros.value = producto.centimetros || 0;
            facProductUnidades.value = producto.unidades || 0;

            detalleProductoFactura.classList.remove('hidden');
            prodNombreFac.textContent = `${producto.referencia} - ${producto.color}`;

            let cantidadDisplay = '';
            if (producto.unidadMedida === 'metros') {
                 const metros = producto.metros || 0;
                 const centimetros = producto.centimetros || 0;
                 cantidadDisplay = `${metros}.${centimetros.toString().padStart(2, '0')} Metros`;
                 descMetros.max = metros;
                 descCentimetros.max = 99;
            } else if (producto.unidadMedida === 'unidades') {
                cantidadDisplay = `${producto.unidades || 0} Unidades`;
                 descUnidades.max = producto.unidades || 0;
            }
            prodCantidadFac.textContent = cantidadDisplay;

            handleCamposDescuento(producto.unidadMedida);

            if (producto.unidadMedida === 'metros') {
                 descMetros.focus();
            } else if (producto.unidadMedida === 'unidades') {
                 descUnidades.focus();
            }
        }


        async function crearFactura(event) {
            event.preventDefault();

            const cliente = facCliente.value.trim();
            const valorTotal = parseFloat(facValor.value);
            const fechaHora = facFechaHora.value.trim();
            const productoId = facProductId.value;

             if (!fechaHora) {
                 showStatusMessage("La fecha es obligatoria.", true);
                 return;
            }


            if (!productoId) {
                 showStatusMessage("Debe seleccionar un producto del inventario.", true);
                 return;
            }

            const unidadMedida = facProductUnit.value;
            let cantidadADescontar = 0;
            let metrosADescontar = 0;
            let centimetrosADescontar = 0;
            let unidadesADescontar = 0;
            let cantidadDisponible = 0;

            if (unidadMedida === 'metros') {
                 metrosADescontar = parseInt(descMetros.value) || 0;
                 centimetrosADescontar = parseInt(descCentimetros.value) || 0;
                 cantidadADescontar = metrosADescontar + centimetrosADescontar / 100;
                 cantidadDisponible = (parseInt(facProductMetros.value) || 0) + (parseInt(facProductCentimetros.value) || 0) / 100;

                 if (cantidadADescontar <= 0) {
                      showStatusMessage("La cantidad a descontar debe ser mayor a 0.", true);
                      return;
                 }

                 if (cantidadADescontar > cantidadDisponible) {
                     showStatusMessage(`Cantidad a descontar (${cantidadADescontar}m) supera la disponible (${cantidadDisponible}m).`, true);
                     return;
                 }

            } else if (unidadMedida === 'unidades') {
                unidadesADescontar = parseInt(descUnidades.value) || 0;
                cantidadADescontar = unidadesADescontar;
                cantidadDisponible = parseInt(facProductUnidades.value) || 0;

                 if (cantidadADescontar <= 0) {
                      showStatusMessage("La cantidad a descontar debe ser mayor a 0.", true);
                      return;
                 }

                 if (cantidadADescontar > cantidadDisponible) {
                     showStatusMessage(`Cantidad a descontar (${cantidadADescontar} unidades) supera la disponible (${cantidadDisponible} unidades).`, true);
                     return;
                 }
            } else {
                 showStatusMessage("Error: Unidad de medida del producto no reconocida.", true);
                 return;
            }

            const productRef = doc(db, "inventario", productoId);
            const productSnap = await getDoc(productRef);
            const productoFacturado = productSnap.exists() ? productSnap.data() : null;

            if (!productoFacturado) {
                 showStatusMessage("Error: No se pudo obtener la información del producto facturado.", true);
                 return;
            }


            const nuevaFactura = {
                fechaHora: fechaHora,
                cliente: cliente,
                producto: {
                    id: productoId,
                    referencia: productoFacturado.referencia,
                    color: productoFacturado.color,
                    unidadMedida: unidadMedida,
                    cantidadFacturada: cantidadADescontar,
                    metrosFacturados: unidadMedida === 'metros' ? metrosADescontar : 0,
                    centimetrosFacturados: unidadMedida === 'metros' ? centimetrosADescontar : 0,
                    unidadesFacturadas: unidadMedida === 'unidades' ? unidadesADescontar : 0,
                    valorUnitario: productoFacturado.valor
                },
                valorTotal: valorTotal // Guardar el valor numérico sin formato
            };

            try {
                await addDoc(facturasCol, nuevaFactura);
                console.log("Factura creada con éxito.");

                let nuevaCantidadEnInventario;
                if (unidadMedida === 'metros') {
                     let totalCmDisponible = (parseInt(facProductMetros.value) || 0) * 100 + (parseInt(facProductCentimetros.value) || 0);
                     let totalCmADescontar = metrosADescontar * 100 + centimetrosADescontar;
                     let totalCmRestante = totalCmDisponible - totalCmADescontar;

                     nuevaCantidadEnInventario = {
                         metros: Math.floor(totalCmRestante / 100),
                         centimetros: totalCmRestante % 100
                     };
                } else if (unidadMedida === 'unidades') {
                    nuevaCantidadEnInventario = {
                        unidades: (parseInt(facProductUnidades.value) || 0) - unidadesADescontar
                    };
                }

                await updateDoc(productRef, nuevaCantidadEnInventario);
                console.log("Inventario actualizado con éxito.");

                showStatusMessage("Factura creada y inventario actualizado con éxito!");
                resetFormFacturacion();
            } catch (e) {
                console.error("Error al crear factura o actualizar inventario: ", e);
                showStatusMessage("Error al crear la factura.", true);
            }
        }


        // --- Event Listeners ---
        btnInventario.addEventListener('click', () => mostrarModulo(moduloInventario));
        btnFacturacion.addEventListener('click', () => mostrarModulo(moduloFacturacion));
        btnVerFacturas.addEventListener('click', () => mostrarModulo(moduloVerFacturas));

        radioMetros.addEventListener('change', handleUnidadMedida);
        radioUnidades.addEventListener('change', handleUnidadMedida);

        formInventario.addEventListener('submit', guardarProducto);

        btnCancelarEdicion.addEventListener('click', resetFormInventario);

        btnExportarInventario.addEventListener('click', exportarInventarioAExcel);
        btnExportarFacturas.addEventListener('click', exportarFacturasAExcel);


        btnBuscarProducto.addEventListener('click', () => {
            moduloBuscarProducto.style.display = 'block';
             inputBuscarProducto.value = '';
             resultadosBusqueda.innerHTML = '<p class="text-center py-2">Escribe para buscar...</p>';
             inputBuscarProducto.focus();
        });

        cerrarBuscarProducto.addEventListener('click', () => {
            moduloBuscarProducto.style.display = 'none';
        });

         window.addEventListener('click', (event) => {
             if (event.target === moduloBuscarProducto) {
                 moduloBuscarProducto.style.display = 'none';
             }
         });

        inputBuscarProducto.addEventListener('input', buscarProductoParaFacturacion);
        inputBuscarInventario.addEventListener('input', filtrarInventario); // Event listener para filtrar inventario


        formFacturacion.addEventListener('submit', crearFactura);


        // --- Inicialización ---
        console.log('DEBUG: Añadiendo listener para DOMContentLoaded.');

        document.addEventListener('DOMContentLoaded', () => {
             console.log('DEBUG: DOMContentLoaded disparado. Iniciando...');

             console.log('DEBUG: invFechaHora al cargar (dentro de DOMContentLoaded):', document.getElementById('invFechaHora'));
             console.log('DEBUG: facFechaHora al cargar (dentro de DOMContentLoaded):', document.getElementById('facFechaHora'));


             mostrarModulo(moduloInventario);
             handleUnidadMedida();
             handleCamposDescuento('');

             console.log('DEBUG: Inicialización completada.');
        });

         if (document.readyState === 'loading') {
             console.log('DEBUG: document.readyState es "loading". Esperando DOMContentLoaded.');
         } else {
              console.log('DEBUG: document.readyState NO es "loading" (es "' + document.readyState + '"). DOM probablemente ya cargado.');
         }

    </script>

</body>
</html>
