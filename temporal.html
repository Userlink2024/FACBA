<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario La Zapatería - Reinventado</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f6f8;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 16px);
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            padding: 14px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background-color: #1e7e34;
        }
        h2 {
            color: #007bff;
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        #search-input {
            width: calc(50% - 16px);
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .item-card {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .item-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }
        .item-details-card span {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-size: 14px;
        }
        .item-actions-card {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .item-actions-card button {
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 6px;
        }
        .edit-input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 5px;
        }
        .edit-controls {
            display: none;
            margin-top: 10px;
        }
        .item-card.editing .item-details-card > span {
            display: none;
        }
        .item-card.editing .edit-input {
            display: inline;
            width: 90px;
        }
        .item-card.editing .edit-controls {
            display: block;
        }
        #total-value {
            margin-top: 30px;
            font-weight: bold;
            color: #333;
            text-align: right;
            font-size: 18px;
        }
        .quantity-input-group {
            display: none;
        }
        .quantity-input-group.active {
            display: block;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script type="text/javascript">
        const firebaseConfig = {
            apiKey: "AIzaSyCwGpyvoUfbXE4rpPfLmHSdOK_VI4mT24M",
            authDomain: "lazapateria-ce24f.firebaseapp.com",
            projectId: "lazapateria-ce24f",
            storageBucket: "lazapateria-ce24f.firebasestorage.app",
            messagingSenderId: "642571845821",
            appId: "1:642571845821:web:45858a0abc0df728fd77d4",
            measurementId: "G-6JCF33H0K1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const inventoryCollection = db.collection('inventario');

        document.addEventListener('DOMContentLoaded', () => {
            const productInput = document.getElementById('product-name');
            const unitSelect = document.getElementById('unit');
            const metersInput = document.getElementById('meters');
            const centimetersInput = document.getElementById('centimeters');
            const valueInput = document.getElementById('value');
            const addButton = document.getElementById('add-item');
            const inventoryList = document.getElementById('inventory-list');
            const totalValueDisplay = document.getElementById('total-value');
            const searchInput = document.getElementById('search-input');
            const providerInput = document.getElementById('provider');
            const clientInput = document.getElementById('client');
            const quantityInputGroup = document.getElementById('quantity-input-group');
            const quantityInput = document.getElementById('quantity');

            let inventoryData = [];
            let editingId = null;

            const renderInventory = (items) => {
                inventoryList.innerHTML = '';
                let totalValue = 0;
                const inventoryGrid = document.createElement('div');
                inventoryGrid.classList.add('inventory-grid');

                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.classList.add('item-card');
                    if (editingId === item.id) {
                        itemCard.classList.add('editing');
                    }

                    // --- Construcción del HTML de la tarjeta ---
                    const h3 = document.createElement('h3');
                    const productNameSpan = document.createElement('span');
                    productNameSpan.classList.add('product-name');
                    productNameSpan.textContent = item.product;
                    const editInputProduct = document.createElement('input');
                    editInputProduct.type = 'text';
                    editInputProduct.classList.add('edit-input');
                    editInputProduct.value = item.product;
                    h3.appendChild(productNameSpan);
                    h3.appendChild(editInputProduct);
                    itemCard.appendChild(h3);

                    const itemDetailsCard = document.createElement('div');
                    itemDetailsCard.classList.add('item-details-card');

                    let unitDisplay = item.unit;
                    if (item.unit === 'metros') {
                        unitDisplay = `${item.meters || 0} m ${item.centimeters || 0} cm`;
                    } else if (item.unit === 'unidades' && item.quantity !== undefined) {
                        unitDisplay = `Cantidad: ${item.quantity}`;
                    }

                    const unitSpan = document.createElement('span');
                    unitSpan.textContent = `Unidad: `;
                    const unitValueSpan = document.createElement('span');
                    unitValueSpan.classList.add('unit');
                    unitValueSpan.textContent = unitDisplay;
                    unitSpan.appendChild(unitValueSpan);
                    itemDetailsCard.appendChild(unitSpan);

                    const unitSelect = document.createElement('select');
                    unitSelect.classList.add('edit-input', 'unit-select');
                    const unidadesOption = document.createElement('option');
                    unidadesOption.value = 'unidades';
                    unidadesOption.textContent = 'Unidades';
                    unidadesOption.selected = item.unit === 'unidades';
                    const metrosOption = document.createElement('option');
                    metrosOption.value = 'metros';
                    metrosOption.textContent = 'Metros con cm';
                    metrosOption.selected = item.unit === 'metros';
                    unitSelect.appendChild(unidadesOption);
                    unitSelect.appendChild(metrosOption);
                    itemDetailsCard.appendChild(unitSelect);

                    if (item.unit === 'unidades' && item.quantity !== undefined) {
                        const quantitySpan = document.createElement('span');
                        quantitySpan.textContent = `Cantidad: ${item.quantity}`;
                        const quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.classList.add('edit-input', 'quantity-input');
                        quantityInput.value = item.quantity || 0;
                        itemDetailsCard.appendChild(quantitySpan);
                        itemDetailsCard.appendChild(quantityInput);
                    }

                    const valueFormatted = item.value !== undefined ? parseFloat(item.value).toFixed(2) : '0.00';
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = `Valor: $${valueFormatted}`;
                    const valueInput = document.createElement('input');
                    valueInput.type = 'number';
                    valueInput.classList.add('edit-input', 'value-input');
                    valueInput.value = item.value || 0;
                    itemDetailsCard.appendChild(valueSpan);
                    itemDetailsCard.appendChild(valueInput);

                    if (item.provider) {
                        const providerSpan = document.createElement('span');
                        providerSpan.textContent = `Proveedor: ${item.provider}`;
                        const providerInput = document.createElement('input');
                        providerInput.type = 'text';
                        providerInput.classList.add('edit-input', 'provider-input');
                        providerInput.value = item.provider || '';
                        itemDetailsCard.appendChild(providerSpan);
                        itemDetailsCard.appendChild(providerInput);
                    }

                    if (item.client) {
                        const clientSpan = document.createElement('span');
                        clientSpan.textContent = `Cliente: ${item.client}`;
                        const clientInput = document.createElement('input');
                        clientInput.type = 'text';
                        clientInput.classList.add('edit-input', 'client-input');
                        clientInput.value = item.client || '';
                        itemDetailsCard.appendChild(clientSpan);
                        itemDetailsCard.appendChild(clientInput);
                    }

                    itemCard.appendChild(itemDetailsCard);

                    const itemActionsCard = document.createElement('div');
                    itemActionsCard.classList.add('item-actions-card');
                    itemActionsCard.dataset.unit = item.unit;
                    itemActionsCard.dataset.itemId = item.id;

                    const createActionButton = (text, className, styleDisplay = 'inline', datasetId = null) => {
                        const button = document.createElement('button');
                        button.textContent = text;
                        button.classList.add('action-button', className);
                        if (datasetId) button.dataset.id = datasetId;
                        button.style.display = styleDisplay;
                        return button;
                    };

                    const createActionInput = (placeholder, className, styleDisplay = 'inline') => {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.classList.add(className);
                        input.placeholder = placeholder;
                        input.value = '0';
                        input.style.display = styleDisplay;
                        return input;
                    };

                    itemActionsCard.appendChild(createActionInput('+ Un', 'add-units', item.unit === 'unidades' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionInput('+ M', 'add-metros', item.unit === 'metros' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionInput('+ Cm', 'add-centimetros', item.unit === 'metros' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionButton('Agregar', 'add-button'));
                    itemActionsCard.appendChild(createActionInput('- Un', 'remove-units', item.unit === 'unidades' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionInput('- M', 'remove-metros', item.unit === 'metros' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionInput('- Cm', 'remove-centimetros', item.unit === 'metros' ? 'inline' : 'none'));
                    itemActionsCard.appendChild(createActionButton('Quitar', 'remove-button'));
                    itemActionsCard.appendChild(createActionButton('Editar', 'edit-button', 'inline', item.id));
                    itemActionsCard.appendChild(createActionButton('Eliminar', 'delete-button', 'inline', item.id));

                    const editControls = document.createElement('div');
                    editControls.classList.add('edit-controls');
                    editControls.appendChild(createActionButton('Guardar', 'save-button', 'inline', item.id));
                    editControls.appendChild(createActionButton('Cancelar', 'cancel-button', 'inline', item.id));
                    itemActionsCard.appendChild(editControls);

                    itemCard.appendChild(itemActionsCard);
                    // --- Fin de la construcción de la tarjeta ---

                    inventoryGrid.appendChild(itemCard);
                    totalValue += parseFloat(item.value || 0);
                });
                inventoryList.appendChild(inventoryGrid);
                totalValueDisplay.textContent = `Valor Total del Inventario: $${totalValue.toFixed(2)}`;

                // Los event listeners para las acciones de los items irán aquí (parte 2)
            };

            db.collection('inventario').onSnapshot((snapshot) => {
                inventoryData = [];
                snapshot.forEach(doc => {
                    inventoryData.push({ id: doc.id, ...doc.data() });
                });
                renderInventory(inventoryData);
            });

            addButton.addEventListener('click', async () => {
                const product = productInput.value.trim();
                const unit = unitSelect.value;
                const meters = parseInt(metersInput.value) || 0;
                const centimeters = parseInt(centimetersInput.value) || 0;
                const value = parseFloat(valueInput.value);
                const provider = providerInput.value.trim();
                const client = clientInput.value.trim();
                const quantity = unit === 'unidades' ? parseInt(quantityInput.value) || 0 : null;

                if (product && !isNaN(value)) {
                    const newItem = {
                        product: product,
                        unit: unit,
                        value: value,
                        timestamp: new Date()
                    };
                    if (provider) newItem.provider = provider;
                    if (client) newItem.client = client;
                    if (unit === 'metros') {
                        newItem.meters = meters;
                        newItem.centimeters = centimeters;
                    } else if (unit === 'unidades') {
                        newItem.quantity = quantity;
                    }

                    try {
                        await db.collection('inventario').add(newItem);
                        productInput.value = '';
                        metersInput.value = '';
                        centimetersInput.value = '';
                        valueInput.value = '';
                        providerInput.value = '';
                        clientInput.value = '';
                        quantityInput.value = '';
                    } catch (error) {
                        console.error("Error al agregar el documento: ", error);
                    }
                } else {
                    alert('Por favor, ingresa el nombre del producto y un valor válido.');
                }
            });

            unitSelect.addEventListener('change', () => {
                const isMetros = unitSelect.value === 'metros';
                const isUnidades = unitSelect.value === 'unidades';
                document.getElementById('meters-group').style.display = isMetros ? 'block' : 'none';
                document.getElementById('centimeters-group').style.display = isMetros ? 'block' : 'none';
                quantityInputGroup.classList.toggle('active', isUnidades);
                metersInput.value = '';
                centimetersInput.value = '';
                quantityInput.value = '';
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredInventory = inventoryData.filter(item =>
                    item.product.toLowerCase().includes(searchTerm) ||
                    (item.provider && item.provider.toLowerCase().includes(searchTerm)) ||
                    (item.client && item.client.toLowerCase().includes(searchTerm))
                );
                renderInventory(filteredInventory);
            });

            // Inicialmente ocultar los campos de metros y centímetros y cantidad
            document.getElementById('meters-group').style.display = 'none';
            document.getElementById('centimeters-group').style.display = 'none';

            // --- Parte 2: Event Listeners para las acciones de los items (se añadirán aquí en la siguiente iteración) ---
            inventoryList.addEventListener('click', (event) => {
                const target = event.target;
                const itemCard = target.closest('.item-card');
                if (!itemCard) return;
                const itemId = itemCard.querySelector('.item-actions-card')?.dataset.itemId;

                if (target.classList.contains('delete-button')) {
                    if (confirm('¿Seguro que quieres eliminar este producto?')) {
                        db.collection('inventario').doc(itemId).delete()
                            .catch((error) => console.error("Error al eliminar el documento: ", error));
                    }
                } else if (target.classList.contains('edit-button')) {
                    itemCard.classList.add('editing');
                } else if (target.classList.contains('cancel-button')) {
                    itemCard.classList.remove('editing');
                } else if (target.classList.contains('save-button')) {
                    const productName = itemCard.querySelector('.edit-input[type="text"]').value;
                    const unit = itemCard.querySelector('.edit-input.unit-select').value;
                    const value = parseFloat(itemCard.querySelector('.edit-input.value-input').value);
                    const provider = itemCard.querySelector('.edit-input.provider-input')?.value;
                    const client = itemCard.querySelector('.edit-input.client-input')?.value;
                    const quantityInput = itemCard.querySelector('.edit-input.quantity-input');
                    const quantity = unit === 'unidades' && quantityInput ? parseInt(quantityInput.value) : null;
                    const metersInputEdit = itemCard.querySelector('.edit-input[type="number"][id^="metros-edit-"]');
                    const centimetersInputEdit = itemCard.querySelector('.edit-input[type="number"][id^="centimeters-edit-"]');
                    const meters = unit === 'metros' && metersInputEdit ? parseInt(metersInputEdit.value) : null;
                    const centimeters = unit === 'metros' && centimetersInputEdit ? parseInt(centimetersInputEdit.value) : null;

                    if (productName && !isNaN(value)) {
                        const updatedItem = {
                            product: productName,
                            unit: unit,
                            value: value
                        };
                        if (provider !== undefined) updatedItem.provider = provider;
                        if (client !== undefined) updatedItem.client = client;
                        if (quantity !== null) updatedItem.quantity = quantity;
                        if (meters !== null) updatedItem.meters = meters;
                        if (centimeters !== null) updatedItem.centimeters = centimeters;

                        db.collection('inventario').doc(itemId).update(updatedItem)
                            .then(() => itemCard.classList.remove('editing'))
                            .catch((error) => console.error("Error al actualizar el documento: ", error));
                    } else {
                        alert('Por favor, asegúrate de que el nombre del producto y el valor sean válidos.');
                    }
                } else if (target.classList.contains('add-button') || target.classList.contains('remove-button')) {
                    const unitType = itemCard.querySelector('.item-actions-card').dataset.unit;
                    const addUnits = parseInt(itemCard.querySelector('.add-units')?.value) || 0;
                    const removeUnits = parseInt(itemCard.querySelector('.remove-units')?.value) || 0;
                    const addMetros = parseInt(itemCard.querySelector('.add-metros')?.value) || 0;
                    const addCentimetros = parseInt(itemCard.querySelector('.add-centimetros')?.value) || 0;
                    const removeMetros = parseInt(itemCard.querySelector('.remove-metros')?.value) || 0;
                    const removeCentimetros = parseInt(itemCard.querySelector('.remove-centimetros')?.value) || 0;

                    const updateData = {};

                    if (unitType === 'unidades' && (addUnits !== 0 || removeUnits !== 0)) {
                        const currentQuantity = inventoryData.find(item => item.id === itemId)?.quantity || 0;
                        updateData.quantity = Math.max(0, currentQuantity + addUnits - removeUnits);
                    } else if (unitType === 'metros' && (addMetros !== 0 || addCentimetros !== 0 || removeMetros !== 0 || removeCentimetros !== 0)) {
                        const currentMeters = inventoryData.find(item => item.id === itemId)?.meters || 0;
                        const currentCentimeters = inventoryData.find(item => item.id === itemId)?.centimeters || 0;

                        let newMeters = currentMeters + addMetros - removeMetros;
                        let newCentimeters = currentCentimeters + addCentimetros - removeCentimetros;

                        if (newCentimeters >= 100) {
                            newMeters += Math.floor(newCentimeters / 100);
                            newCentimeters %= 100;
                        } else if (newCentimeters < 0) {
                            newMeters += Math.ceil(newCentimeters / 100) -1;
                            newCentimeters = (newCentimeters % 100 + 100) % 100;
                        }
                        updateData.meters = Math.max(0, newMeters);
                        updateData.centimeters = Math.max(0, newCentimeters);
                    }

                    if (Object.keys(updateData).length > 0) {
                        db.collection('inventario').doc(itemId).update(updateData)
                            .then(() => {
                                if (itemCard.querySelector('.add-units')) itemCard.querySelector('.add-units').value = 0;
                                if (itemCard.querySelector('.remove-units')) itemCard.querySelector('.remove-units').value = 0;
                                if (itemCard.querySelector('.add-metros')) itemCard.querySelector('.add-metros').value = 0;
                                if (itemCard.querySelector('.add-centimetros')) itemCard.querySelector('.add-centimetros').value = 0;
                                if (itemCard.querySelector('.remove-metros')) itemCard.querySelector('.remove-metros').value = 0;
                                if (itemCard.querySelector('.remove-centimetros')) itemCard.querySelector('.remove-centimetros').value = 0;
                            })
                            .catch((error) => console.error("Error al actualizar la cantidad/medida: ", error));
                    }
                }
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Inventario La Zapatería</h1>

        <div class="input-group">
            <label for="product-name">Nuevo Producto:</label>
            <input type="text" id="product-name" placeholder="Nombre del producto">
        </div>

        <div class="input-group">
            <label for="unit">Unidad de medida:</label>
            <select id="unit">
                <option value="unidades">Unidades</option>
                <option value="metros">Metros con centímetros</option>
            </select>
        </div>

        <div class="input-group quantity-input-group" id="quantity-input-group">
            <label for="quantity">Cantidad:</label>
            <input type="number" id="quantity" placeholder="Cantidad">
        </div>

        <div class="input-group" id="meters-group">
            <label for="meters">Metros:</label>
            <input type="number" id="meters" placeholder="Metros">
        </div>

        <div class="input-group" id="centimeters-group">
            <label for="centimeters">Centímetros:</label>
            <input type="number" id="centimeters" placeholder="Centímetros">
        </div>

        <div class="input-group">
            <label for="value">Valor:</label>
            <input type="number" id="value" placeholder="Valor del producto">
        </div>

        <div class="input-group">
            <label for="provider">Proveedor:</label>
            <input type="text" id="provider" placeholder="Nombre del proveedor (opcional)">
        </div>

        <div class="input-group">
            <label for="client">Cliente:</label>
            <input type="text" id="client" placeholder="Nombre del cliente (opcional)">
        </div>

        <button id="add-item">Agregar Nuevo Producto</button>

        <h2>Inventario Actual</h2>
        <input type="text" id="search-input" placeholder="Buscar producto, proveedor o cliente...">
        <div id="inventory-list">
            <p>Cargando inventario...</p>
        </div>

        <div id="total-value">
            Valor Total del Inventario: $0.00
        </div>
    </div>
</body>
</html>
