<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Moderno</title>
    <style>
        /* Asegurar que html y body ocupen toda la altura de la ventana */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0; /* Eliminar padding del body aquí y añadirlo al contenedor si es necesario */
        }

        /* Estilos generales y de contenedor */
        body {
            font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif; /* Intentar fuente similar a Apple */
            background-color: #f2f2f7; /* Fondo gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Usar min-height para asegurar altura mínima */
            box-sizing: border-box;
        }

        #chat-container {
            width: 100%; /* Ocupar todo el ancho disponible hasta el max-width */
            max-width: 700px; /* Aumentar el ancho máximo */
            background-color: #ffffff; /* Fondo blanco limpio */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra más suave */
            border-radius: 15px; /* Bordes más redondeados */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Ajuste clave: max-height basado en el 100% de su padre (body) */
            max-height: 100%;
            height: 100%; /* Asegurar que ocupe la altura disponible */
            box-sizing: border-box;
             padding: 20px; /* Añadir padding aquí en lugar del body */
        }

        /* Estilos para la sección de ingreso de nombre */
        #name-prompt {
            padding: 30px 20px; /* Más padding */
            text-align: center;
            background-color: #e5e5ea; /* Gris claro */
            border-bottom: 1px solid #d1d1d6; /* Borde sutil */
            flex-shrink: 0; /* Evitar que se encoja */
        }

        #name-prompt h2 {
            margin-top: 0;
            color: #1c1c1e; /* Texto oscuro */
            font-size: 1.5em; /* Aumentar tamaño del título */
        }

        #name-prompt input {
            padding: 12px 15px; /* Más padding */
            margin-right: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px; /* Bordes redondeados */
            font-size: 1.1em; /* Aumentar tamaño de fuente */
            box-sizing: border-box; /* Incluir padding y border */
        }

        #name-prompt button {
            padding: 12px 20px; /* Más padding */
            background-color: #007aff; /* Azul de Apple */
            color: white;
            border: none;
            border-radius: 8px; /* Bordes redondeados */
            cursor: pointer;
            font-size: 1.1em; /* Aumentar tamaño de fuente */
            transition: background-color 0.2s ease-in-out;
        }

        #name-prompt button:hover {
            background-color: #0056b3; /* Azul más oscuro */
        }

        /* Estilos para la caja de chat (mensajes) */
        #chat-box {
            flex-grow: 1; /* Permite que la caja de chat ocupe el espacio restante */
            padding: 20px;
            overflow-y: auto; /* Habilita el scroll vertical si los mensajes exceden la altura */
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Más espacio entre mensajes */
            height: 0; /* Usar height: 0 para que flex-grow funcione correctamente en columna */

            /* Estilos para la imagen de fondo - ACTUALIZADO */
            background-image: url('https://images.unsplash.com/photo-1518655048521-f130df041722?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); /* URL de imagen de fondo moderna y sobria */
            background-size: cover; /* Cubrir el área del contenedor */
            background-position: center; /* Centrar la imagen */
            background-repeat: no-repeat; /* No repetir la imagen */
        }

        /* Estilos para cada mensaje individual */
        .message {
            padding: 12px 18px; /* Aumentar padding del mensaje */
            border-radius: 18px; /* Bordes más redondeados */
            max-width: 85%; /* Aumentar ancho máximo */
            word-wrap: break-word;
            position: relative;
            line-height: 1.5; /* Mejorar espaciado entre líneas */
            font-size: 1.1em; /* Aumentar tamaño de fuente base del mensaje */
            /* Añadir un fondo semi-transparente para que el texto sea legible sobre la imagen */
            background-color: rgba(255, 255, 255, 0.9); /* Blanco con 90% de opacidad */
        }

        .message .name {
             font-size: 0.9em; /* Tamaño de fuente del nombre (relativo al 1.1em del mensaje) */
             color: #3a3a3c; /* Color de texto sutil */
             margin-bottom: 2px; /* Espacio debajo del nombre */
             display: block;
             font-weight: 600; /* Semi-negrita */
        }

        .message .text {
            display: block;
            color: #1c1c1e; /* Texto oscuro principal */
            font-size: 1em; /* Tamaño de fuente del texto (relativo al 1.1em del mensaje) */
            margin-bottom: 4px; /* Espacio entre texto y hora */
        }

        .message .timestamp {
            font-size: 0.7em; /* Tamaño de fuente de la hora (relativo al 1.1em del mensaje) */
            color: #8e8e93; /* Gris tenue */
            text-align: right;
            display: block;
        }

        /* Estilos para mensajes recibidos */
        .message.received {
            background-color: rgba(229, 229, 234, 0.9); /* Gris claro con 90% de opacidad */
            align-self: flex-start;
            border-bottom-left-radius: 5px; /* Esquina inferior izquierda menos redondeada */
        }

        /* Estilos para mensajes enviados */
        .message.sent {
            background-color: rgba(0, 122, 255, 0.9); /* Azul con 90% de opacidad */
            color: white; /* Texto blanco */
            align-self: flex-end;
            border-bottom-right-radius: 5px; /* Esquina inferior derecha menos redondeada */
        }

         /* Estilos para mensajes enviados - elementos internos */
        .message.sent .name,
        .message.sent .text,
        .message.sent .timestamp {
            color: white; /* Asegurar que el texto interno sea blanco */
        }
         .message.sent .timestamp {
             color: rgba(255, 255, 255, 0.8); /* Hora ligeramente transparente en mensajes enviados */
         }

        /* Estilos para contenido de archivo dentro de mensajes */
        .message img {
            max-width: 100%; /* Asegura que la imagen no se desborde */
            height: auto;
            border-radius: 8px; /* Bordes redondeados para imágenes */
            margin-top: 5px; /* Espacio arriba de la imagen */
        }

         .message audio {
             width: 100%; /* Reproductor de audio ocupa todo el ancho */
             margin-top: 5px; /* Espacio arriba del reproductor */
         }


        /* Estilos para el área de entrada de mensajes */
        .message-input-area {
            display: flex;
            padding: 15px 20px; /* Padding consistente */
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
            align-items: center;
            gap: 10px; /* Espacio entre elementos */
            flex-shrink: 0; /* Evita que el área de entrada se encoja */
        }

        .message-input-area input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #d1d1d6;
            border-radius: 20px; /* Bordes muy redondeados */
            font-size: 1.1em;
            box-sizing: border-box;
            outline: none; /* Eliminar contorno al enfocar */
            transition: border-color 0.2s ease-in-out;
        }
         .message-input-area input[type="text"]:focus {
             border-color: #007aff; /* Borde azul al enfocar */
         }


         .message-input-area .input-buttons {
             display: flex;
             gap: 5px; /* Espacio entre los botones */
             align-items: center; /* Centrar verticalmente los botones */
         }

         /* Estilo base para los botones de icono */
        .message-input-area button {
            padding: 10px; /* Padding uniforme para botones de icono */
            background-color: #e5e5ea; /* Fondo gris claro para botones de icono */
            color: #007aff; /* Color azul para iconos */
            border: none;
            border-radius: 50%; /* Botones redondos */
            cursor: pointer;
            width: 45px; /* Tamaño fijo para botones redondos */
            height: 45px; /* Tamaño fijo para botones redondos */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }

         /* Estilo específico para el botón de enviar */
         #send-button {
             background-color: #007aff; /* Fondo azul para enviar */
             color: white; /* Texto blanco */
             border-radius: 20px; /* Bordes redondeados */
             padding: 10px 20px; /* Padding horizontal */
             width: auto; /* Ancho automático */
             height: auto; /* Altura automática */
         }

         #send-button:hover {
             background-color: #0056b3;
         }

         /* Estilo específico para el botón de emoji */
         #emoji-button {
             /* Ya tiene estilos base de .message-input-area button */
         }

         #emoji-button svg {
             width: 22px; /* Tamaño del icono SVG */
             height: 22px; /* Tamaño del icono SVG */
             fill: #3a3a3c; /* Color del icono oscuro */
         }
          #emoji-button:hover {
              background-color: #d1d1d6; /* Gris un poco más oscuro al pasar el ratón */
          }

         /* Estilo para los botones de archivo */
         .file-button {
             /* Hereda estilos de .message-input-area button */
         }
          .file-button svg {
              width: 22px;
              height: 22px;
              fill: #3a3a3c;
          }
           .file-button:hover {
               background-color: #d1d1d6;
           }

         /* Estilo para el botón de grabar audio */
         #record-audio-button {
            background-color: #ff3b30; /* Rojo para grabar */
         }
         #record-audio-button.recording {
             background-color: #c62828; /* Rojo más oscuro al grabar */
             animation: pulse 1s infinite; /* Animación de pulso */
         }

         @keyframes pulse {
             0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
             70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
             100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
         }

         #record-audio-button svg {
             width: 22px;
             height: 22px;
             fill: white; /* Icono blanco al grabar */
         }
          #record-audio-button:hover {
              background-color: #c62828;
          }


         /* Ocultar los input[type="file"] por defecto */
         input[type="file"] {
             display: none;
         }


        /* Estilos para el indicador de escribiendo */
        #typing-indicator {
            font-size: 0.9em; /* Aumentar tamaño */
            color: #8e8e93; /* Gris tenue */
            padding: 5px 20px;
            min-height: 1.2em; /* Reserva espacio */
            flex-shrink: 0; /* Evitar que se encoja */
        }

        /* Estilos para el botón de limpiar chat */
        #clear-chat-button {
            padding: 8px 15px; /* Más padding */
            background-color: #ff3b30; /* Rojo de Apple */
            color: white;
            border: none;
            border-radius: 8px; /* Bordes redondeados */
            cursor: pointer;
            font-size: 0.9em; /* Tamaño de fuente */
            margin: 10px 20px; /* Margen arriba/abajo y padding lateral */
            align-self: flex-start; /* Alinear a la izquierda o puedes centrarlo si prefieres */
            flex-shrink: 0; /* Evitar que se encoja */
            transition: background-color 0.2s ease-in-out;
        }

        #clear-chat-button:hover {
            background-color: #c62828; /* Rojo más oscuro */
        }


        /* Oculta la interfaz de chat inicialmente */
        #chat-interface {
            display: none;
            flex-direction: column;
            flex-grow: 1; /* Asegura que la interfaz de chat ocupe el espacio disponible */
             /* Ajuste clave: Darle una altura al contenedor flex para que los hijos flex-grow funcionen */
            height: 100%;
        }

        /* Media query para pantallas más pequeñas */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Menos padding en móviles */
            }
            #chat-container {
                max-height: calc(100vh - 20px); /* Ajustar altura máxima */
                border-radius: 10px;
                 padding: 10px; /* Menos padding en móviles */
            }

            #name-prompt {
                padding: 20px 15px;
            }

            #name-prompt input,
            #name-prompt button,
            .message-input-area input,
            .message-input-area button,
            #send-button {
                font-size: 1em; /* Ajustar tamaño de fuente */
                padding: 10px 12px; /* Ajustar padding */
            }

             #name-prompt input {
                 margin-right: 0;
                 width: 100%;
                 margin-bottom: 10px; /* Espacio debajo del input en móviles */
             }
             #name-prompt button {
                 width: 100%; /* Botón ocupa todo el ancho */
             }


             .message-input-area {
                 flex-direction: row; /* Mantener en fila */
                 padding: 10px 15px;
                 gap: 5px;
             }

             .message-input-area input[type="text"] { /* Especificar input de texto */
                 margin-right: 5px;
             }

             .message-input-area .input-buttons {
                 gap: 5px;
             }


             #emoji-button, .file-button, #record-audio-button, #send-button { /* Añadir .file-button y #record-audio-button */
                 width: 40px;
                 height: 40px;
                 padding: 0; /* Eliminar padding extra */
                 flex-shrink: 0; /* Evitar que se reduzcan */
             }
              #send-button {
                  width: auto; /* Permitir que el botón de enviar ajuste su ancho */
                  padding: 10px 15px;
              }


              #emoji-button svg, .file-button svg, #record-audio-button svg { /* Añadir .file-button svg y #record-audio-button svg */
                 width: 20px;
                 height: 20px;
             }

             #clear-chat-button {
                 font-size: 0.8em;
                 padding: 6px 12px;
                 margin: 10px 15px;
             }

             .message {
                 max-width: 90%; /* Permitir que los mensajes ocupen más ancho */
             }
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-analytics-compat.js"></script>

</head>
<body>

    <div id="chat-container">
        <div id="name-prompt">
            <h2>Ingresa tu nombre</h2>
            <input type="text" id="name-input" placeholder="Tu nombre">
            <button id="start-chat-button">Entrar al Chat</button>
        </div>

        <div id="chat-interface">
             <div id="typing-indicator"></div>
            <div id="chat-box">
                </div>
            <div class="message-input-area">
                <input type="text" id="message-input" placeholder="Escribe un mensaje...">
                <div class="input-buttons">
                     <button id="emoji-button" title="Insertar Emoji">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.514 0-10-4.486-10-10s4.486-10 10-10 10 4.486 10 10-4.486 10-10 10zm-3-8c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm6 0c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm-3 4c-2.04 0-3.831-1.242-4.588-3h9.176c-.757 1.758-2.548 3-4.588 3z"/>
                        </svg>
                    </button>

                    <label for="image-upload" class="file-button" title="Enviar Imagen">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M22 5v14c0 1.654-1.346 3-3 3h-14c-1.654 0-3-1.346-3-3v-14c0-1.654 1.346-3 3-3h14c1.654 0 3 1.346 3 3zm-14 2c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm-2 14c0 .552.449 1 1 1h14c.551 0 1-.448 1-1v-1.723l-3.774-3.773c-.92-.92-2.419-.92-3.339 0l-3.774 3.774v1.722zm16-1.723v-10.277h-14v1.723l3.774 3.774c.92.92 2.419.92 3.339 0l3.774-3.774z"/>
                        </svg>
                    </label>
                    <input type="file" id="image-upload" accept="image/*">

                    <button id="record-audio-button" title="Grabar Audio">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                             <path d="M12 2c1.1 0 2 .9 2 2v9c0 1.1-.9 2-2 2s-2-.9-2-2v-9c0-1.1.9-2 2-2zm0-2c-2.21 0-4 1.79-4 4v9c0 2.21 1.79 4 4 4s4-1.79 4-4v-9c0-2.21-1.79-4-4-4zm8 9h-2c0 4.42-3.58 8-8 8s-8-3.58-8-8h-2c0 5.52 4.47 10 10 10s10-4.48 10-10z"/>
                         </svg>
                     </button>

                     <button id="send-button">Enviar</button>
                </div>
            </div>
             <button id="clear-chat-button">Limpiar Chat</button>
        </div>
    </div>

    <audio id="notification-sound" src="sonido_mensaje.mp3" preload="auto"></audio>


    <script>
        // Configuración de tu aplicación web de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBVtSkeQe1WZna6nKC4vGxd4ISaRBQ5SVY",
            authDomain: "facba-a160c.firebaseapp.com",
            projectId: "facba-a160c",
            storageBucket: "facba-a160c.firebasestorage.app",
            messagingSenderId: "585530132394",
            appId: "1:585530132394:web:a25cda63f883f786804dd3",
            measurementId: "G-S29LSYM8TQ",
            // Añadir explícitamente la URL de la base de datos
            databaseURL: "https://facba-a160c-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); // Obtener la instancia de Realtime Database
        const storage = firebase.storage(); // Obtener la instancia de Storage

        let userName = ''; // Variable para almacenar el nombre del usuario
        let typingTimeout; // Para manejar el indicador de escribiendo
        let initialLoadComplete = false; // Bandera para saber si la carga inicial de mensajes ha terminado

        // Variables para grabación de audio
        let mediaRecorder;
        let audioChunks = [];
        let audioStream; // Para mantener la referencia al stream del micrófono


        // Obtener elementos del DOM
        const namePrompt = document.getElementById('name-prompt');
        const nameInput = document.getElementById('name-input');
        const startChatButton = document.getElementById('start-chat-button');
        const chatInterface = document.getElementById('chat-interface');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator'); // Elemento para el indicador
        const notificationSound = document.getElementById('notification-sound'); // Elemento de audio
        const clearChatButton = document.getElementById('clear-chat-button'); // Botón de limpiar chat
        const emojiButton = document.getElementById('emoji-button'); // Botón de emoji
        const imageUploadInput = document.getElementById('image-upload'); // Input de archivo de imagen
        // const audioUploadInput = document.getElementById('audio-upload'); // Input de archivo de audio (si se mantiene adjuntar)
        const recordAudioButton = document.getElementById('record-audio-button'); // Botón de grabar audio


        // --- Lógica de Ingreso de Nombre ---
        startChatButton.addEventListener('click', () => {
            const enteredName = nameInput.value.trim(); // Obtener el nombre y eliminar espacios en blanco
            if (enteredName) {
                userName = enteredName;
                namePrompt.style.display = 'none'; // Ocultar la sección de nombre
                chatInterface.style.display = 'flex'; // Mostrar la interfaz de chat
                messageInput.focus(); // Poner el foco en el campo de mensaje
                // Opcional: Guardar el nombre en localStorage para recordarlo
                localStorage.setItem('chatName', userName);
                loadMessages(); // Cargar los mensajes existentes una vez que se establece el nombre
                setupTypingIndicator(); // Configurar el indicador de escribiendo

                // Intentar "desbloquear" el audio con una reproducción silenciosa al iniciar el chat
                // Esto ayuda a que las notificaciones futuras puedan sonar
                 if (notificationSound) {
                     notificationSound.volume = 0; // Volumen a cero
                     notificationSound.play().then(() => {
                         notificationSound.pause(); // Pausar inmediatamente
                         notificationSound.volume = 1; // Restaurar volumen
                     }).catch(error => {
                         console.warn("Audio unlock failed (user interaction needed):", error);
                     });
                 }

            } else {
                // Usar un mensaje en el DOM en lugar de alert()
                // Podrías añadir un elemento div para mostrar errores
                 console.log('Por favor, ingresa un nombre.'); // Usar console.log como alternativa simple
            }
        });

        // Permitir presionar Enter en el campo de nombre
        nameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                startChatButton.click(); // Simular clic en el botón
            }
        });


        // --- Lógica del Chat ---

        // Referencia al nodo 'messages' en la base de datos
        const messagesRef = database.ref('messages'); // 'messages' es el nombre del nodo
        // Referencia al nodo para el estado de escritura
        const typingRef = database.ref('typing');
         // Referencia a la raíz de Storage
        const storageRef = storage.ref();


        // Clave para limpiar el chat (¡Mantén esto seguro en una aplicación real!)
        const CLEAR_CHAT_PASSWORD = '170518';


        // Función para formatear el timestamp a HH:MM
        function formatTimestamp(timestamp) {
            if (!timestamp) return ''; // Manejar caso sin timestamp
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Función para enviar un mensaje de texto
        function sendMessage() {
            console.log("sendMessage function called."); // Debugging log
            const messageText = messageInput.value.trim(); // Obtener el texto del mensaje y limpiar
            console.log("Message text:", messageText); // Debugging log
            console.log("User name:", userName); // Debugging log

            if (messageText && userName) { // Asegurarse de que haya texto y nombre de usuario
                const newMessage = {
                    name: userName,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // Usar el timestamp del servidor de Firebase
                };

                console.log("Attempting to send text message:", newMessage); // Debugging log

                // Enviar el nuevo mensaje de texto a la base de datos
                messagesRef.push(newMessage)
                    .then(() => {
                        console.log("Mensaje de texto enviado exitosamente!");
                        messageInput.value = ''; // Limpiar el campo de entrada
                        setTypingStatus(false); // Limpiar estado de escritura
                    })
                    .catch((error) => {
                        console.error("Error al enviar mensaje de texto:", error);
                        // Mostrar mensaje de error al usuario
                    });
            } else {
                 console.log("Message not sent: text or user name missing."); // Debugging log
            }
        }

         // Función para enviar un mensaje de archivo (imagen o audio)
         function sendFileMessage(file, fileType) {
             if (!userName) {
                 console.log("Cannot send file: user name not set.");
                 return;
             }

             // Crear una referencia única en Storage para el archivo
             const uniqueFileName = `${Date.now()}-${file.name}`;
             const fileRef = storageRef.child(`${fileType}s/${uniqueFileName}`); // e.g., images/12345-photo.jpg, audios/67890-voice.mp3

             console.log(`Attempting to upload ${fileType} file:`, file.name);

             // Subir el archivo
             const uploadTask = fileRef.put(file);

             // Monitorear el progreso de la subida (opcional)
             uploadTask.on('state_changed',
                 (snapshot) => {
                     // Progreso...
                     const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                     console.log(`Upload of ${fileType} is ${progress}% done`);
                     // Podrías mostrar una barra de progreso en la UI
                 },
                 (error) => {
                     // Manejar errores de subida
                     console.error(`Error uploading ${fileType}:`, error);
                     // Mostrar mensaje de error al usuario
                 },
                 () => {
                     // Subida completada exitosamente
                     console.log(`${fileType} uploaded successfully.`);
                     // Obtener la URL de descarga del archivo
                     uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                         console.log(`File available at: ${downloadURL}`);

                         // Crear el objeto del mensaje con la URL y tipo de archivo
                         const newMessage = {
                             name: userName,
                             fileUrl: downloadURL,
                             fileType: fileType, // 'image' o 'audio'
                             timestamp: firebase.database.ServerValue.TIMESTAMP
                         };

                         console.log(`Attempting to send ${fileType} message to DB:`, newMessage);

                         // Enviar el mensaje a la base de datos
                         messagesRef.push(newMessage)
                             .then(() => {
                                 console.log(`${fileType} message sent to DB successfully!`);
                                 // Limpiar los inputs de archivo si se usaron (aunque el input de grabar es diferente)
                                 imageUploadInput.value = '';
                                 // audioUploadInput.value = ''; // Si se mantiene adjuntar audio
                                 setTypingStatus(false); // Limpiar estado de escritura
                             })
                             .catch((error) => {
                                 console.error(`Error sending ${fileType} message to DB:`, error);
                                 // Mostrar mensaje de error al usuario
                             });
                     });
                 }
             );
         }


        // Listener para el botón de enviar texto
        sendButton.addEventListener('click', sendMessage);

        // Permitir presionar Enter en el campo de mensaje de texto
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage(); // Simular clic en el botón
            }
        });

         // Listener para el input de archivo de imagen
         imageUploadInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
             if (file) {
                 sendFileMessage(file, 'image');
             }
         });

         // Listener para el input de archivo de audio (si se mantiene adjuntar)
         /*
         audioUploadInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
             if (file) {
                 sendFileMessage(file, 'audio');
             }
         });
         */


         // --- Lógica de Grabación de Audio ---

         // Función para iniciar la grabación
         async function startRecording() {
             if (!userName) {
                 console.log("Cannot start recording: user name not set.");
                 return;
             }

             try {
                 // Solicitar acceso al micrófono
                 audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                 audioChunks = []; // Limpiar fragmentos anteriores

                 // Crear MediaRecorder
                 // Intentar formatos comunes, fallback a lo que el navegador soporte
                 let options = { mimeType: 'audio/webm' };
                 if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                     options = { mimeType: 'audio/mp4' };
                     if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                          options = { mimeType: 'audio/ogg' };
                           if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                               console.warn('No common audio formats supported, trying default.');
                               options = {}; // Usar formato por defecto del navegador
                           }
                     }
                 }
                 mediaRecorder = new MediaRecorder(audioStream, options);


                 // Evento cuando hay datos de audio disponibles
                 mediaRecorder.ondataavailable = (event) => {
                     audioChunks.push(event.data);
                 };

                 // Evento cuando la grabación se detiene
                 mediaRecorder.onstop = () => {
                     // Combinar los fragmentos en un Blob
                     const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                     console.log("Recording stopped, Blob created:", audioBlob);

                     // Enviar el Blob de audio a Firebase Storage
                     // Usar 'audio' como fileType para que se guarde en la carpeta 'audios'
                     // Generar un nombre de archivo más descriptivo para audio grabado
                     const audioFileName = `voice_message_${Date.now()}.${audioBlob.type.split('/')[1] || 'webm'}`;
                     const audioFile = new File([audioBlob], audioFileName, { type: audioBlob.type });


                     sendFileMessage(audioFile, 'audio');

                     // Detener el stream del micrófono
                     audioStream.getTracks().forEach(track => track.stop());
                 };

                 // Iniciar la grabación
                 mediaRecorder.start();
                 console.log("Recording started...");

                 // Actualizar la UI para indicar que se está grabando
                 recordAudioButton.classList.add('recording');
                 messageInput.placeholder = 'Grabando audio...';
                 messageInput.disabled = true; // Deshabilitar input de texto mientras se graba
                 sendButton.disabled = true; // Deshabilitar botón de enviar texto
                 emojiButton.disabled = true; // Deshabilitar botón de emoji
                 imageUploadInput.disabled = true; // Deshabilitar input de imagen
                 // audioUploadInput.disabled = true; // Si se mantiene adjuntar audio

             } catch (error) {
                 console.error("Error accessing microphone or starting recording:", error);
                 // Mostrar un mensaje al usuario si no se pudo acceder al micrófono
             }
         }

         // Función para detener la grabación
         function stopRecording() {
             if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                 mediaRecorder.stop();
                 console.log("Recording stopping...");

                 // Restaurar la UI
                 recordAudioButton.classList.remove('recording');
                 messageInput.placeholder = 'Escribe un mensaje...';
                 messageInput.disabled = false; // Habilitar input de texto
                 sendButton.disabled = false; // Habilitar botón de enviar texto
                 emojiButton.disabled = false; // Habilitar botón de emoji
                 imageUploadInput.disabled = false; // Habilitar input de imagen
                 // audioUploadInput.disabled = false; // Si se mantiene adjuntar audio
             }
         }

         // Listener para el botón de grabar/detener
         recordAudioButton.addEventListener('click', () => {
             if (mediaRecorder && mediaRecorder.state === 'recording') {
                 // Si está grabando, detener
                 stopRecording();
             } else {
                 // Si no está grabando, iniciar
                 startRecording();
             }
         });


         // --- Lógica del Indicador de Escribiendo ---

        // Función para establecer el estado de escritura en Firebase
        function setTypingStatus(isTyping) {
            if (!userName) return; // No hacer nada si el nombre del usuario no está establecido

            const userTypingRef = typingRef.child(userName); // Referencia al estado del usuario actual

            if (isTyping) {
                userTypingRef.set(true); // Establecer el estado a true
                // Limpiar el estado después de un tiempo si el usuario deja de escribir
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    userTypingRef.remove(); // Eliminar el estado después de 1.5 segundos
                }, 1500);
            } else {
                 // Limpiar el timeout si existe
                 if (typingTimeout) {
                     clearTimeout(typingTimeout);
                     typingTimeout = null;
                 }
                 userTypingRef.remove(); // Eliminar el estado si ya no está escribiendo
            }
        }

        // Listener para el campo de entrada de mensaje para detectar escritura
        messageInput.addEventListener('input', () => {
            // Solo actualizar estado de escritura si no estamos grabando audio
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                 // No hacer nada si estamos grabando
            } else {
                if (messageInput.value.trim().length > 0) {
                    setTypingStatus(true); // El usuario está escribiendo
                } else {
                    setTypingStatus(false); // El usuario ha borrado el texto
                }
            }
        });

        // Configurar el listener para el estado de escritura de otros usuarios
        function setupTypingIndicator() {
            typingRef.on('value', (snapshot) => {
                const typingUsers = snapshot.val();
                const usersTyping = [];

                if (typingUsers) {
                    // Iterar sobre los usuarios que están escribiendo
                    for (const name in typingUsers) {
                        // Asegurarse de que no sea el usuario actual
                        if (name !== userName) {
                            usersTyping.push(name);
                        }
                    }
                }

                // Actualizar el texto del indicador
                if (usersTyping.length > 0) {
                    typingIndicator.textContent = `${usersTyping.join(', ')} está escribiendo...`;
                } else {
                    typingIndicator.textContent = ''; // Limpiar si nadie está escribiendo
                }
            });
        }


        // Función para cargar y mostrar mensajes
        function loadMessages() {
             console.log("loadMessages function called."); // Debugging log

             // Primero, cargar mensajes existentes (uso 'once' para no recargar todo cada vez)
             messagesRef.once('value', (snapshot) => {
                 console.log("Initial message load complete.");
                 const messages = snapshot.val();
                 if (messages) {
                     const messageList = Object.values(messages);
                     messageList.sort((a, b) => a.timestamp - b.timestamp);
                     messageList.forEach((msg) => {
                         displayMessage(msg); // Mostrar cada mensaje
                     });
                 }
                 chatBox.scrollTop = chatBox.scrollHeight; // Scroll al final
                 initialLoadComplete = true; // Marcar la carga inicial como completa

                 // Luego, escuchar solo los nuevos mensajes ('child_added')
                 messagesRef.on('child_added', (data) => {
                     const newMessage = data.val();
                     // Solo procesar mensajes nuevos después de la carga inicial
                     // También se procesan mensajes durante la carga inicial con displayMessage
                     // pero el sonido solo se activa si initialLoadComplete es true
                     if (initialLoadComplete) {
                         displayMessage(newMessage); // Mostrar el nuevo mensaje

                         // Reproducir sonido si el mensaje no es del usuario actual y no es un archivo
                         // (Opcional: podrías querer sonidos diferentes para archivos)
                         if (newMessage.name !== userName && !newMessage.fileType) {
                             playNotificationSound();
                         }

                         chatBox.scrollTop = chatBox.scrollHeight; // Scroll al final
                     } else {
                         // Durante la carga inicial, solo mostramos el mensaje sin sonido
                         displayMessage(newMessage);
                     }
                 });
             });

             // Limpiar listener 'value' anterior si existiera (para evitar duplicados)
             // Esto es importante si loadMessages pudiera llamarse múltiples veces
             // messagesRef.off('value'); // Descomentar si es necesario
        }

        // Función para mostrar un mensaje en el DOM
        function displayMessage(msg) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            // Añadir clase 'sent' o 'received'
            if (msg.name === userName) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }

            // Crear elementos para el nombre, texto y timestamp
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('name');
            // Solo mostrar el nombre si no es el mensaje del usuario actual (opcional, estilo WhatsApp)
            if (msg.name !== userName) {
               nameSpan.textContent = msg.name + ': ';
            } else {
               nameSpan.textContent = ''; // No mostrar el nombre en mensajes propios
            }

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = formatTimestamp(msg.timestamp); // Formatear y mostrar hora

            // Añadir nombre al elemento del mensaje si no es el usuario actual
            if (msg.name !== userName) {
                 messageElement.appendChild(nameSpan);
            }

            // --- Mostrar contenido del mensaje (texto, imagen, audio) ---
            if (msg.text) {
                // Es un mensaje de texto
                const textSpan = document.createElement('span');
                textSpan.classList.add('text');
                textSpan.textContent = msg.text;
                messageElement.appendChild(textSpan);
            } else if (msg.fileType === 'image' && msg.fileUrl) {
                // Es un mensaje de imagen
                const imgElement = document.createElement('img');
                imgElement.src = msg.fileUrl;
                imgElement.alt = "Imagen enviada"; // Texto alternativo accesible
                messageElement.appendChild(imgElement);
            } else if (msg.fileType === 'audio' && msg.fileUrl) {
                // Es un mensaje de audio (grabado o adjunto)
                const audioElement = document.createElement('audio');
                audioElement.controls = true; // Mostrar controles de reproducción
                audioElement.src = msg.fileUrl;
                messageElement.appendChild(audioElement);
            }
            // --- Fin de mostrar contenido ---


            messageElement.appendChild(timestampSpan); // Añadir la hora al final

            chatBox.appendChild(messageElement);
        }

        // Función para reproducir el sonido de notificación
        function playNotificationSound() {
             if (notificationSound) {
                 notificationSound.currentTime = 0; // Reiniciar el sonido si ya se está reproduciendo
                 notificationSound.play().catch(error => {
                     console.error("Error al reproducir el sonido:", error);
                     // Esto a menudo ocurre si el navegador bloquea el autoplay
                 });
             }
        }

        // --- Lógica para Limpiar Chat con Clave ---
        clearChatButton.addEventListener('click', () => {
            // Usar prompt() para solicitar la clave
            const enteredPassword = prompt("Ingresa la clave para limpiar el chat:");

            // Verificar la clave
            if (enteredPassword === CLEAR_CHAT_PASSWORD) {
                // Si la clave es correcta, eliminar el nodo 'messages' de Firebase
                messagesRef.remove()
                    .then(() => {
                        console.log("Chat limpiado exitosamente!");
                        // Opcional: Mostrar un mensaje al usuario en el DOM
                        // chatBox.innerHTML = '<div>Chat limpiado.</div>';
                    })
                    .catch((error) => {
                        console.error("Error al limpiar el chat:", error);
                        // Mostrar mensaje de error al usuario
                    });
            } else {
                // Si la clave es incorrecta
                console.log("Clave incorrecta. El chat no fue limpiado.");
                // Mostrar mensaje de clave incorrecta al usuario
            }
        });

        // --- Lógica del Botón de Emoji ---
        emojiButton.addEventListener('click', () => {
            // Al hacer clic en el botón de emoji, simplemente enfocamos el campo de texto.
            // La mayoría de los navegadores modernos y sistemas operativos permiten
            // abrir el selector de emojis del sistema usando atajos de teclado
            // (Ej: Win + . en Windows, Ctrl + Cmd + Espacio en macOS)
            // o a veces haciendo clic derecho en el campo de texto.
            // Implementar un selector de emojis integrado es más complejo.
            messageInput.focus();
            console.log("Botón de emoji clickeado. Usa el selector de emojis de tu sistema operativo.");
        });


        // Comprobar si hay un nombre guardado en localStorage al cargar la página
        const savedName = localStorage.getItem('chatName');
        if (savedName) {
            nameInput.value = savedName; // Rellenar el campo de nombre
            startChatButton.click(); // Simular clic en el botón para iniciar el chat automáticamente
        }

    </script>

</body>
</html>
