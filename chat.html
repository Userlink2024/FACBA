<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Moderno</title>
    <style>
        /* Asegurar que html y body ocupen toda la altura de la ventana */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0; /* Eliminar padding del body aquí y añadirlo al contenedor si es necesario */
            overflow: hidden; /* Prevenir scroll del body */
        }

        /* Estilos generales y de contenedor */
        body {
            font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif; /* Intentar fuente similar a Apple */
            background-color: #f2f2f7; /* Fondo gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Usar min-height para asegurar altura mínima */
            box-sizing: border-box;
        }

        #chat-container {
            width: 100%; /* Ocupar todo el ancho disponible hasta el max-width */
            max-width: 700px; /* Aumentar el ancho máximo */
            background-color: #ffffff; /* Fondo blanco limpio */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra más suave */
            border-radius: 15px; /* Bordes más redondeados */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Ajuste clave: max-height basado en el 100% de su padre (body) */
            max-height: 100%;
            height: 100%; /* Asegurar que ocupe la altura disponible */
            box-sizing: border-box;
             padding: 20px; /* Añadir padding aquí en lugar del body */
        }

        /* Estilos para la sección de ingreso de nombre */
        #name-prompt {
            padding: 30px 20px; /* Más padding */
            text-align: center;
            background-color: #e5e5ea; /* Gris claro */
            border-bottom: 1px solid #d1d1d6; /* Borde sutil */
            flex-shrink: 0; /* Evitar que se encoja */
        }

        #name-prompt h2 {
            margin-top: 0;
            color: #1c1c1e; /* Texto oscuro */
            font-size: 1.5em; /* Aumentar tamaño del título */
        }

        #name-prompt input {
            padding: 12px 15px; /* Más padding */
            margin-right: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px; /* Bordes redondeados */
            font-size: 1.1em; /* Aumentar tamaño de fuente */
            box-sizing: border-box; /* Incluir padding y border */
        }

        #name-prompt button {
            padding: 12px 20px; /* Más padding */
            background-color: #007aff; /* Azul de Apple */
            color: white;
            border: none;
            border-radius: 8px; /* Bordes redondeados */
            cursor: pointer;
            font-size: 1.1em; /* Aumentar tamaño de fuente */
            transition: background-color 0.2s ease-in-out;
        }

        #name-prompt button:hover {
            background-color: #0056b3; /* Azul más oscuro */
        }

        /* Estilos para el encabezado del chat */
        #chat-header {
            display: flex;
            justify-content: flex-end; /* Alinear elementos a la derecha */
            align-items: center;
            padding: 0 20px 10px 20px; /* Padding superior, sin padding lateral extra */
            flex-shrink: 0;
            position: relative; /* Para posicionar el dropdown */
        }

        /* Estilos para la caja de chat (mensajes) */
        #chat-box {
            flex-grow: 1; /* Permite que la caja de chat ocupe el espacio restante */
            padding: 0 20px; /* Padding lateral */
            overflow-y: auto; /* Habilita el scroll vertical si los mensajes exceden la altura */
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Más espacio entre mensajes */
            /* Usar height: 0 en un contenedor flex con flex-direction: column
               permite que el elemento con flex-grow: 1 ocupe el espacio restante
               y habilita el scroll cuando el contenido se desborda. */
            height: 0;

            /* Estilos para la imagen de fondo */
            background-image: url('https://images.unsplash.com/photo-1518655048521-f130df041722?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); /* URL de imagen de fondo moderna y sobria */
            background-size: cover; /* Cubrir el área del contenedor */
            background-position: center; /* Centrar la imagen */
            background-repeat: no-repeat; /* No repetir la imagen */
             /* Padding inferior dinámico ajustado por JS para el teclado */
            padding-bottom: 20px; /* Padding inicial */
        }

        /* Estilos para cada mensaje individual */
        .message {
            padding: 12px 18px; /* Aumentar padding del mensaje */
            border-radius: 18px; /* Bordes más redondeados */
            max-width: 85%; /* Aumentar ancho máximo */
            word-wrap: break-word;
            position: relative;
            line-height: 1.5; /* Mejorar espaciado entre líneas */
            font-size: 1.1em; /* Aumentar tamaño de fuente base del mensaje */
            /* Añadir un fondo semi-transparente para que el texto sea legible sobre la imagen */
            background-color: rgba(255, 255, 255, 0.9); /* Blanco con 90% de opacidad */
            cursor: pointer; /* Indicar que se puede hacer clic para responder */
        }

        .message .name {
             font-size: 0.9em; /* Tamaño de fuente del nombre (relativo al 1.1em del mensaje) */
             color: #3a3a3c; /* Color de texto sutil */
             margin-bottom: 2px; /* Espacio debajo del nombre */
             display: block;
             font-weight: 600; /* Semi-negrita */
        }

        .message .text {
            display: block;
            color: #1c1c1e; /* Texto oscuro principal */
            font-size: 1em; /* Tamaño de fuente del texto (relativo al 1.1em del mensaje) */
            margin-bottom: 4px; /* Espacio entre texto y hora */
        }

        .message .timestamp {
            font-size: 0.7em; /* Tamaño de fuente de la hora (relativo al 1.1em del mensaje) */
            color: #8e8e93; /* Gris tenue */
            text-align: right;
            display: block;
        }

        /* Estilos para mensajes recibidos */
        .message.received {
            background-color: rgba(229, 229, 234, 0.9); /* Gris claro con 90% de opacidad */
            align-self: flex-start;
            border-bottom-left-radius: 5px; /* Esquina inferior izquierda menos redondeada */
        }

        /* Estilos para mensajes enviados */
        .message.sent {
            background-color: rgba(0, 122, 255, 0.9); /* Azul con 90% de opacidad */
            color: white; /* Texto blanco */
            align-self: flex-end;
            border-bottom-right-radius: 5px; /* Esquina inferior derecha menos redondeada */
        }

         /* Estilos para mensajes enviados - elementos internos */
        .message.sent .name,
        .message.sent .text,
        .message.sent .timestamp {
            color: white; /* Asegurar que el texto interno sea blanco */
        }
         .message.sent .timestamp {
             color: rgba(255, 255, 255, 0.8); /* Hora ligeramente transparente en mensajes enviados */
         }

        /* Estilos para el área de entrada de mensajes */
        .message-input-area {
            display: flex;
            flex-direction: column; /* Mantener como columna principal */
            padding: 15px 20px; /* Padding consistente */
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
            align-items: center; /* Centrar horizontalmente */
            gap: 10px; /* Espacio entre elementos */
            flex-shrink: 0; /* Evita que el área de entrada se encoja */
            position: relative; /* Necesario para posicionar el selector de emojis */
        }

        /* Contenedor para el input y los botones */
        .input-container {
            display: flex; /* Alinear elementos horizontalmente */
            align-items: center; /* Centrar verticalmente */
            gap: 10px; /* Espacio entre input y botones */
            width: 100%; /* Ocupar todo el ancho disponible */
        }


        /* Estilos para el INPUT TYPE="TEXT" */
        .message-input-area input[type="text"] {
            flex-grow: 1; /* Permite que el input ocupe el espacio restante */
            /* Ajuste de padding para hacerlo menos "gordo" */
            padding: 8px 15px;
            border: 1px solid #d1d1d6;
            border-radius: 20px; /* Bordes muy redondeados */
            font-size: 1.1em;
            box-sizing: border-box;
            outline: none; /* Eliminar contorno al enfocar */
            transition: border-color 0.2s ease-in-out;
            /* Altura ajustada para hacerlo más delgado */
            height: 40px; /* Altura fija similar a los botones */
            line-height: 1.5; /* Igual que los mensajes para consistencia */
            /* width: 100%; Eliminado, flex-grow lo maneja */
        }
         .message-input-area input[type="text"]:focus {
             border-color: #007aff; /* Borde azul al enfocar */
         }


         .message-input-area .input-buttons {
             display: flex; /* Alinear botones horizontalmente */
             gap: 5px; /* Espacio entre los botones */
             align-items: center; /* Centrar verticalmente los botones */
             flex-shrink: 0; /* Evitar que los botones se encojan */
         }

         /* Estilo base para los botones de icono */
        .message-input-area button {
            padding: 10px; /* Padding uniforme para botones de icono */
            background-color: #e5e5ea; /* Fondo gris claro para botones de icono */
            color: #007aff; /* Color azul para iconos */
            border: none;
            border-radius: 50%; /* Botones redondos */
            cursor: pointer;
            /* Ajuste de tamaño fijo para botones redondos */
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }

         /* Estilo específico para el botón de enviar */
         #send-button {
             background-color: #007aff; /* Fondo azul para enviar */
             color: white; /* Texto blanco */
             border-radius: 20px; /* Bordes redondeados */
             padding: 10px 20px; /* Padding horizontal */
             width: auto; /* Ancho automático */
             height: auto; /* Altura automática */
         }

         #send-button:hover {
             background-color: #0056b3;
         }

         /* Estilo específico para el botón de emoji */
         #emoji-button {
             /* Ya tienen estilos base de .message-input-area button */
         }

         #emoji-button svg {
             width: 22px; /* Tamaño del icono SVG */
             height: 22px; /* Tamaño del icono SVG */
             fill: #3a3a3c; /* Color del icono oscuro */
         }
          #emoji-button:hover {
              background-color: #d1d1d6; /* Gris un poco más oscuro al pasar el ratón */
          }

        /* Estilos para el indicador de escribiendo */
        #typing-indicator {
            font-size: 0.9em; /* Aumentar tamaño */
            color: #8e8e93; /* Gris tenue */
            padding: 5px 20px;
            min-height: 1.2em; /* Reserva espacio */
            flex-shrink: 0; /* Evitar que se encoja */
            /* Alineación a la derecha */
            align-self: flex-end;
            /* Ajuste de margen para pegarlo a la barra de input */
            margin-bottom: 5px;
        }

        /* Estilos para el botón de limpiar chat */
        /* Ahora dentro del dropdown */
        #settings-dropdown #clear-chat-button {
            padding: 10px 15px; /* Padding para elemento de menú */
            background-color: transparent; /* Fondo transparente */
            color: #1c1c1e; /* Color de texto oscuro */
            border: none;
            border-radius: 0; /* Sin bordes redondeados */
            cursor: pointer;
            font-size: 1em; /* Tamaño de fuente estándar */
            margin: 0; /* Sin margen */
            width: 100%; /* Ocupar todo el ancho del dropdown */
            text-align: left; /* Alinear texto a la izquierda */
            transition: background-color 0.1s ease-in-out;
            display: block; /* Asegurar que sea un bloque para ocupar el ancho */
        }

        #settings-dropdown #clear-chat-button:hover {
            background-color: #e5e5ea; /* Fondo gris claro al pasar el ratón */
            color: #ff3b30; /* Color rojo al pasar el ratón */
        }


        /* Oculta la interfaz de chat inicialmente */
        #chat-interface {
            display: none;
            flex-direction: column;
            flex-grow: 1; /* Asegura que la interfaz de chat ocupe el espacio disponible */
             /* Ajuste clave: Darle una altura al contenedor flex para que los hijos flex-grow funcionen */
            height: 100%;
            position: relative; /* Necesario para posicionar el selector de emojis si se pone fuera del input-area */
        }

        /* Estilos para el selector de emojis */
        #emoji-picker {
            display: none; /* Oculto por defecto */
            position: absolute;
            /* bottom se ajusta dinámicamente en JS */
            left: 20px; /* Alinear a la izquierda */
            background-color: #fff;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10; /* Asegurar que esté por encima de otros elementos */
            max-height: 200px; /* Altura máxima para scroll */
            overflow-y: auto; /* Habilitar scroll si hay muchos emojis */
            width: calc(100% - 40px); /* Ocupar el ancho del contenedor con padding */
            box-sizing: border-box;
            flex-wrap: wrap; /* Permite que los emojis se envuelvan */
            gap: 5px; /* Espacio entre emojis */
        }

        #emoji-picker span {
            cursor: pointer;
            font-size: 1.5em; /* Tamaño de los emojis */
            padding: 3px;
            border-radius: 4px;
            transition: background-color 0.1s ease-in-out;
        }

        #emoji-picker span:hover {
            background-color: #e5e5ea;
        }

        /* Estilos para la vista previa del mensaje al responder */
        #reply-preview {
            display: none; /* Oculto por defecto */
            background-color: #e5e5ea; /* Fondo gris claro */
            border-left: 4px solid #007aff; /* Barra azul a la izquierda */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px; /* Espacio debajo de la vista previa */
            width: 100%; /* Ocupar todo el ancho */
            box-sizing: border-box;
            position: relative; /* Para posicionar el botón de cerrar */
        }

        #reply-preview .reply-name {
            font-size: 0.9em;
            color: #3a3a3c;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }

        #reply-preview .reply-text {
            font-size: 1em;
            color: #1c1c1e;
            display: block;
            /* Limitar el texto para que no sea demasiado largo */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #reply-preview #cancel-reply-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #8e8e93; /* Color gris */
            font-size: 1.2em;
        }

        #reply-preview #cancel-reply-button:hover {
            color: #3a3a3c; /* Gris más oscuro al pasar el ratón */
        }

        /* Estilos para mostrar el contenido de la respuesta dentro de un mensaje */
        .message .reply-content {
            background-color: rgba(0, 0, 0, 0.05); /* Fondo ligeramente oscuro */
            border-left: 4px solid rgba(0, 122, 255, 0.5); /* Barra azul semi-transparente */
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px; /* Espacio debajo del contenido de respuesta */
            font-size: 0.9em; /* Tamaño de fuente más pequeño */
            word-wrap: break-word;
        }

        .message.sent .reply-content {
             border-left-color: rgba(255, 255, 255, 0.5); /* Barra blanca semi-transparente en mensajes enviados */
        }


        .message .reply-content .reply-name {
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
            color: #3a3a3c; /* Color de texto sutil */
        }
         .message.sent .reply-content .reply-name {
             color: rgba(255, 255, 255, 0.8); /* Color de texto sutil en mensajes enviados */
         }


        .message .reply-content .reply-text {
            display: block;
            color: #1c1c1e; /* Texto oscuro */
            /* Limitar el texto para que no sea demasiado largo */
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
         .message.sent .reply-content .reply-text {
             color: white; /* Texto blanco en mensajes enviados */
         }


        /* Estilos para el menú desplegable de configuración */
        #settings-dropdown {
            display: none; /* Oculto por defecto */
            position: absolute;
            /* bottom y right se ajustan dinámicamente en JS o se calculan */
            background-color: #fff;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10; /* Asegurar que esté por encima de otros elementos */
            min-width: 150px; /* Ancho mínimo del menú */
            padding: 5px 0; /* Padding interno */
            flex-direction: column; /* Elementos apilados verticalmente */
            top: 40px; /* Posicionar debajo del botón de settings */
            right: 20px; /* Alinear a la derecha del chat-header */
        }


        /* Media query para pantallas más pequeñas (Android) */
        @media (max-width: 768px) {
            body {
                padding: 0; /* Eliminar padding del body en móviles */
            }
            #chat-container {
                /* Ajuste de altura para móviles - JS se encargará de la altura dinámica */
                max-width: 100vw; /* Ocupar todo el ancho del viewport */
                border-radius: 0; /* Eliminar bordes redondeados en pantalla completa */
                 padding: 0; /* Eliminar padding del contenedor en móviles */
                 /* Altura inicial para móviles - JS ajustará */
                 height: 100vh;
                 max-height: 100vh;
            }

            #name-prompt {
                padding: 20px 15px;
            }

            #name-prompt input,
            #name-prompt button {
                font-size: 1em; /* Ajustar tamaño de fuente */
                padding: 10px 12px; /* Ajustar padding */
            }

             #name-prompt input[type="text"] { /* Especificar input de texto */
                 margin-right: 5px;
                 align-self: center; /* Centrar verticalmente */
             }

             .message-input-area {
                 flex-direction: column; /* Mantener en columna */
                 padding: 10px 15px;
                 gap: 5px;
                 align-items: center; /* Centrar horizontalmente */
                 /* Ajuste para móviles */
                 max-width: 100vw;
                 left: 0;
                 right: 0;
             }

             .message-input-area .input-buttons {
                 gap: 5px;
                 align-items: center; /* Centrar verticalmente */
                 /* justify-content: flex-end; Eliminado */
                 flex-shrink: 0; /* Asegurar que no se encoja */
             }

             /* Ajuste para input[type="text"] en móviles */
             .message-input-area input[type="text"] {
                 font-size: 1em;
                 padding: 8px 12px; /* Ajustar padding */
                 height: 40px; /* Altura fija */
                 min-height: 40px; /* Asegurar altura mínima */
                 flex-grow: 1;
                 /* width: 100%; Eliminado */
                 box-sizing: border-box;
             }

             .input-container {
                 flex-direction: row; /* Alinear horizontalmente en móviles */
                 align-items: center;
                 gap: 5px;
             }


             #emoji-button, #send-button {
                 width: 40px;
                 height: 40px;
                 padding: 0; /* Eliminar padding extra */
                 flex-shrink: 0; /* Evitar que se reduzcan */
                 align-self: center; /* Centrar verticalmente */
             }
              #send-button {
                  width: auto; /* Permitir que el botón de enviar ajuste su ancho */
                  padding: 10px 15px;
              }


              #emoji-button svg, #settings-button svg {
                 width: 20px;
                 height: 20px;
             }

             #settings-button {
                 /* Ajuste de tamaño y posición para móviles */
                 width: 40px;
                 height: 40px;
                 padding: 0;
                 align-self: center;
             }

             #settings-dropdown #clear-chat-button {
                 font-size: 0.9em;
                 padding: 8px 12px;
             }

             .message {
                 max-width: 90%; /* Permitir que los mensajes ocupen más ancho */
             }

             /* Ajuste del indicador de escribiendo en móviles */
             #typing-indicator {
                 align-self: flex-end; /* Alinear a la derecha */
                 margin-bottom: 5px; /* Espacio arriba del input */
                 padding: 5px 15px; /* Ajustar padding lateral para móviles */
             }

             /* Ajuste del selector de emojis en móviles */
             #emoji-picker {
                 /* bottom se ajustará dinámicamente en JS */
                 left: 10px;
                 width: calc(100% - 20px); /* Ajustar ancho para móviles */
             }

             /* Ajuste de la vista previa de respuesta en móviles */
             #reply-preview {
                 padding: 8px 10px;
             }

             /* Ajuste del dropdown de settings en móviles */
             #settings-dropdown {
                 top: 40px; /* Posicionar debajo del botón de settings */
                 right: 10px; /* Alinear a la derecha en móviles */
                 left: auto; /* Desactivar alineación izquierda */
             }
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-analytics-compat.js"></script>

</head>
<body>

    <div id="chat-container">
        <div id="name-prompt">
            <h2>Ingresa tu nombre</h2>
            <input type="text" id="name-input" placeholder="Tu nombre">
            <button id="start-chat-button">Entrar al Chat</button>
        </div>

        <div id="chat-interface">
            <div id="chat-header">
                 <button id="settings-button" title="Configuración">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <path d="M24 13.616v-3.232c-1.651-.587-2.694-.758-3.281-2.042-.587-1.285-.185-2.178.419-3.742 1.809-4.642-1.489-8.396-5.072-8.396-1.464 0-2.856.543-3.807 1.499-.95.951-1.493 2.245-1.493 3.809 0 2.628-1.391 3.424-4.058 3.815-1.207.175-2.921.273-4.916.306v3.232c2.002.04 3.715.138 4.92.302 2.668.392 4.06 1.189 4.06 3.817 0 1.563.544 2.856 1.493 3.807.951.951 2.343 1.494 3.808 1.494 3.583 0 6.881-3.758 5.072-8.398-.606-1.56-.204-2.453.42-3.738 1.586-3.293 3.564-3.488 3.279-4.075zm-12 7.384c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z"/>
                      </svg>
                 </button>
                 <div id="settings-dropdown">
                     <button id="clear-chat-button">Limpiar Chat</button>
                 </div>
            </div>
             <div id="chat-box">
                </div>
            <div id="typing-indicator"></div>
            <div class="message-input-area">
                 <div id="emoji-picker">
                     </div>
                 <div id="reply-preview">
                     <span class="reply-name"></span>
                     <span class="reply-text"></span>
                     <button id="cancel-reply-button">×</button>
                 </div>
                 <div class="input-container">
                    <input type="text" id="message-input" placeholder="Escribe un mensaje...">
                    <div class="input-buttons">
                         <button id="emoji-button" title="Insertar Emoji">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.514 0-10-4.486-10-10s4.486-10 10-10 10 4.486 10 10-4.486 10-10 10zm-3-8c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm6 0c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm-3 4c-2.04 0-3.831-1.242-4.588-3h9.176c-.757 1.758-2.548 3-4.588 3z"/>
                            </svg>
                        </button>
                         <button id="send-button">Enviar</button>
                    </div>
                 </div>
            </div>
             </div>
    </div>

    <audio id="notification-sound" src="sonido_mensaje.mp3" preload="auto"></audio>


    <script>
        // Configuración de tu aplicación web de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBVtSkeQe1WZna6nKC4vxd4ISRBRB5SVY", // Reemplaza con tu apiKey
            authDomain: "facba-a160c.firebaseapp.com", // Reemplaza con tu authDomain
            projectId: "facba-a160c", // Reemplaza con tu projectId
            storageBucket: "facba-a160c.firebasestorage.app", // Reemplaza con tu storageBucket (aunque no se use Storage)
            messagingSenderId: "585530132394", // Reemplaza con tu messagingSenderId
            appId: "1:585530132394:web:a25cda63f883f786804dd3", // Reemplaza con tu appId
            measurementId: "G-S29LSYM8TQ", // Reemplaza con tu measurementId
            // Añadir explícitamente la URL de la base de datos
            databaseURL: "https://facba-a160c-default-rtdb.firebaseio.com/" // Reemplaza con tu databaseURL
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); // Obtener la instancia de Realtime Database

        let userName = ''; // Variable para almacenar el nombre del usuario
        let typingTimeout; // Para manejar el indicador de escribiendo
        let initialLoadComplete = false; // Bandera para saber si la carga inicial de mensajes ha terminado

        // Variable para almacenar los datos del mensaje al que se está respondiendo
        let replyingToMessage = null;


        // Obtener elementos del DOM
        const namePrompt = document.getElementById('name-prompt');
        const nameInput = document.getElementById('name-input');
        const startChatButton = document.getElementById('start-chat-button');
        const chatInterface = document.getElementById('chat-interface');
        const chatBox = document.getElementById('chat-box');
        // Cambiado de textarea a input type="text"
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator'); // Elemento para el indicador
        const notificationSound = document.getElementById('notification-sound'); // Elemento de audio
        const emojiButton = document.getElementById('emoji-button'); // Botón de emoji
        const emojiPicker = document.getElementById('emoji-picker'); // Selector de emojis
        const replyPreview = document.getElementById('reply-preview'); // Vista previa de respuesta
        const replyNameSpan = replyPreview.querySelector('.reply-name');
        const replyTextSpan = replyPreview.querySelector('.reply-text');
        const cancelReplyButton = document.getElementById('cancel-reply-button');
        // Nuevos elementos para configuración
        const settingsButton = document.getElementById('settings-button'); // Ahora en chat-header
        const settingsDropdown = document.getElementById('settings-dropdown'); // Ahora en chat-header
        const clearChatButton = document.getElementById('clear-chat-button'); // Ahora dentro del dropdown
        const chatContainer = document.getElementById('chat-container'); // Referencia al contenedor principal
        const messageInputArea = document.querySelector('.message-input-area'); // Referencia al área de input


        // --- Lógica de Ingreso de Nombre ---
        startChatButton.addEventListener('click', () => {
            const enteredName = nameInput.value.trim(); // Obtener el nombre y eliminar espacios en blanco
            if (enteredName) {
                userName = enteredName;
                namePrompt.style.display = 'none'; // Ocultar la sección de nombre
                chatInterface.style.display = 'flex'; // Mostrar la interfaz de chat
                messageInput.focus(); // Poner el foco en el campo de mensaje
                // Opcional: Guardar el nombre en localStorage para recordarlo
                localStorage.setItem('chatName', userName);
                loadMessages(); // Cargar los mensajes existentes una vez que se establece el nombre
                setupTypingIndicator(); // Configurar el indicador de escribiendo

                // Intentar "desbloquear" el audio con una reproducción silenciosa al iniciar el chat
                // Esto ayuda a que las notificaciones futuras puedan sonar
                 if (notificationSound) {
                     notificationSound.volume = 0; // Volumen a cero
                     notificationSound.play().then(() => {
                         notificationSound.pause(); // Pausar inmediatamente
                         notificationSound.volume = 1; // Restaurar volumen
                     }).catch(error => {
                         console.error("Audio unlock failed (user interaction needed):", error);
                     });
                 }

            } else {
                // Usar un mensaje en el DOM en lugar de alert()
                // Podrías añadir un elemento div para mostrar errores
                 console.log('Por favor, ingresa un nombre.'); // Usar console.log como alternativa simple
            }
        });

        // Permitir presionar Enter en el campo de nombre
        nameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                startChatButton.click(); // Simular clic en el botón
            }
        });


        // --- Lógica del Chat (Realtime Database) ---

        // Referencia al nodo 'messages' en la base de datos
        const messagesRef = database.ref('messages'); // 'messages' es el nombre del nodo
        // Referencia al nodo para el estado de escritura
        const typingRef = database.ref('typing');


        // Clave para limpiar el chat (¡Mantén esto seguro en una aplicación real!)
        const CLEAR_CHAT_PASSWORD = '170518';


        // Función para formatear el timestamp a HH:MM
        function formatTimestamp(timestamp) {
            if (!timestamp) return ''; // Manejar caso sin timestamp
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Función para enviar un mensaje (texto o respuesta)
        function sendMessage() {
            console.log("sendMessage function called."); // Debugging log
            const messageText = messageInput.value.trim(); // Obtener el texto del mensaje y limpiar
            console.log("Message text:", messageText); // Debugging log
            console.log("User name:", userName); // Debugging log

            if (messageText && userName) { // Asegurarse de que haya texto y nombre de usuario
                const newMessage = {
                    name: userName,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // Usar el timestamp del servidor de Firebase
                };

                // Si estamos respondiendo a un mensaje, añadir la referencia
                if (replyingToMessage) {
                    newMessage.replyTo = {
                        id: replyingToMessage.id, // ID único del mensaje original
                        name: replyingToMessage.name,
                        content: replyingToMessage.text ? replyingToMessage.text.substring(0, 50) + (replyingToMessage.text.length > 50 ? '...' : '') : 'Archivo' // Fragmento del texto o indicar que es archivo
                    };
                    console.log("Sending as a reply to:", replyingToMessage.id); // Debugging log
                }

                console.log("Attempting to send message to Realtime Database:", newMessage); // Debugging log

                // Enviar el nuevo mensaje a la base de datos
                messagesRef.push(newMessage)
                    .then(() => {
                        console.log("Mensaje enviado exitosamente a Realtime Database!");
                        messageInput.value = ''; // Limpiar el campo de entrada
                        setTypingStatus(false); // Limpiar estado de escritura
                        cancelReply(); // Cancelar el estado de respuesta después de enviar
                    })
                    .catch((error) => {
                        console.error("Error al enviar mensaje a Realtime Database:", error);
                        // Mostrar mensaje de error al usuario
                    });
            } else {
                 console.log("Message not sent: text or user name missing."); // Debugging log
            }
        }

        // Listener para el botón de enviar texto
        sendButton.addEventListener('click', sendMessage);

        // Permitir presionar Enter en el campo de mensaje de texto
        messageInput.addEventListener('keypress', (event) => {
            // Solo enviar con Enter, no permitir saltos de línea en input type="text"
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevenir el envío por defecto del formulario (si existiera)
                sendMessage(); // Enviar el mensaje
            }
        });


         // --- Lógica de Ajuste de Altura del Textarea (Eliminada) ---
         // Eliminada función adjustTextareaHeight y sus listeners


         // --- Lógica del Indicador de Escribiendo (Realtime Database) ---

        // Función para establecer el estado de escritura en Realtime Database
        function setTypingStatus(isTyping) {
            if (!userName) return; // No hacer nada si el nombre del usuario no está establecido

            const userTypingRef = typingRef.child(userName); // Referencia al estado del usuario actual en RTDB

            if (isTyping) {
                userTypingRef.set(true); // Establecer el estado a true
                // Limpiar el estado después de un tiempo si el usuario deja de escribir
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    userTypingRef.remove(); // Eliminar el estado después de 1.5 segundos
                }, 1500);
            } else {
                 // Limpiar el timeout si existe
                 if (typingTimeout) {
                     clearTimeout(typingTimeout);
                     typingTimeout = null;
                 }
                 userTypingRef.remove(); // Eliminar el estado si ya no está escribiendo
            }
        }

        // Listener para el campo de entrada de mensaje para detectar escritura
        messageInput.addEventListener('input', () => {
            if (messageInput.value.trim().length > 0) {
                setTypingStatus(true); // El usuario está escribiendo
            } else {
                setTypingStatus(false); // El usuario ha borrado el texto
            }
        });

        // Configurar el listener para el estado de escritura de otros usuarios
        function setupTypingIndicator() {
            typingRef.on('value', (snapshot) => { // Listener en RTDB
                const typingUsers = snapshot.val();
                const usersTyping = [];

                if (typingUsers) {
                    // Iterar sobre los usuarios que están escribiendo
                    for (const name in typingUsers) {
                        // Asegurarse de que no sea el usuario actual
                        if (name !== userName) {
                            usersTyping.push(name);
                        }
                    }
                }

                // Actualizar el texto del indicador
                if (usersTyping.length > 0) {
                    typingIndicator.textContent = `${usersTyping.join(', ')} está escribiendo...`;
                } else {
                    typingIndicator.textContent = ''; // Limpiar si nadie está escribiendo
                }
            });
        }


        // --- Lógica para Cargar y Mostrar Mensajes (Realtime Database) ---

        // Función para cargar y mostrar mensajes (Realtime Database)
        function loadMessages() {
             console.log("loadMessages function called."); // Debugging log

             // Escuchar en tiempo real los mensajes desde Realtime Database
             messagesRef.on('child_added', (data) => {
                 const newMessage = data.val();
                 const messageId = data.key; // Obtener el ID único del mensaje
                 console.log("New message received from Realtime Database:", newMessage, "ID:", messageId); // Debugging log
                 displayMessage(newMessage, messageId); // Pasar el ID a displayMessage

                 // Reproducir sonido si el mensaje no es del usuario actual
                 if (initialLoadComplete && newMessage.name !== userName) {
                     playNotificationSound();
                 }

                 chatBox.scrollTop = chatBox.scrollHeight; // Scroll al final

                 // Marcar la carga inicial como completa después del primer mensaje (o ajustar la lógica si es necesario)
                 if (!initialLoadComplete) {
                     initialLoadComplete = true;
                 }
             }, (error) => {
                 console.error("Error loading messages from Realtime Database:", error);
             });

             // Cargar mensajes existentes una vez al inicio
             messagesRef.once('value', (snapshot) => {
                 console.log("Initial message load from Realtime Database complete.");
                 const messages = snapshot.val();
                 if (messages) {
                     // Convertir objeto de mensajes a array y ordenar por timestamp
                     const messageList = Object.keys(messages).map(key => ({ id: key, ...messages[key] }));
                     messageList.sort((a, b) => a.timestamp - b.timestamp);

                     // Limpiar el chatbox antes de cargar los mensajes existentes
                     chatBox.innerHTML = '';

                     messageList.forEach((msg) => {
                         displayMessage(msg, msg.id); // Pasar el ID a displayMessage
                     });
                 }
                 chatBox.scrollTop = chatBox.scrollHeight; // Scroll al final
                 initialLoadComplete = true; // Marcar la carga inicial como completa
             }, (error) => {
                 console.error("Error fetching initial messages from Realtime Database:", error);
             });
        }

        // Función para mostrar un mensaje en el DOM
        function displayMessage(msg, messageId) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.dataset.messageId = messageId; // Almacenar el ID del mensaje en el elemento DOM

            // Añadir clase 'sent' o 'received'
            if (msg.name === userName) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }

            // Crear elementos para el nombre, texto y timestamp
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('name');
            /* Solo mostrar el nombre si no es el mensaje del usuario actual (opcional, estilo WhatsApp) */
            if (msg.name !== userName) {
               nameSpan.textContent = msg.name + ': ';
            } else {
               nameSpan.textContent = ''; // No mostrar el nombre en mensajes propios
            }

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = formatTimestamp(msg.timestamp); // Formatear y mostrar hora

            // Añadir nombre al elemento del mensaje si no es el usuario actual
            if (msg.name !== userName) {
                 messageElement.appendChild(nameSpan);
            }

            // --- Mostrar contenido de la respuesta si existe ---
            if (msg.replyTo) {
                const replyContentDiv = document.createElement('div');
                replyContentDiv.classList.add('reply-content');

                const replyName = document.createElement('span');
                replyName.classList.add('reply-name');
                replyName.textContent = msg.replyTo.name + ':';

                const replyText = document.createElement('span');
                replyText.classList.add('reply-text');
                replyText.textContent = msg.replyTo.content;

                replyContentDiv.appendChild(replyName);
                replyContentDiv.appendChild(replyText);
                messageElement.appendChild(replyContentDiv);
            }
            /* --- Fin de mostrar contenido de respuesta --- */


            // --- Mostrar contenido del mensaje (solo texto ahora) ---
            if (msg.text) {
                // Es un mensaje de texto
                const textSpan = document.createElement('span');
                textSpan.classList.add('text');
                textSpan.textContent = msg.text;
                messageElement.appendChild(textSpan);
            }
            /* --- Fin de mostrar contenido --- */


            messageElement.appendChild(timestampSpan); // Añadir la hora al final

            chatBox.appendChild(messageElement);

             // Reproducir sonido solo para mensajes entrantes que no sean del usuario actual
             if (initialLoadComplete && msg.name !== userName) {
                 playNotificationSound();
             }

             // Añadir listener de clic para responder
             messageElement.addEventListener('click', () => {
                 // Crear un objeto con los datos necesarios para la respuesta
                 const messageDataForReply = {
                     id: messageId,
                     name: msg.name,
                     text: msg.text || '', // Usar texto si existe, vacío si es archivo
                     // Puedes añadir más propiedades si quieres referenciar archivos en el futuro
                 };
                 startReply(messageDataForReply);
             });
        }

        // Función para reproducir el sonido de notificación
        function playNotificationSound() {
             if (notificationSound) {
                 notificationSound.currentTime = 0; // Reiniciar el sonido si ya se está reproduciendo
                 notificationSound.play().catch(error => {
                     console.error("Error al reproducir el sonido:", error);
                     // Esto a menudo ocurre si el navegador bloquea el autoplay
                 });
             }
        }

        // --- Lógica para Limpiar Chat con Clave (Realtime Database) ---
        // El listener ahora está asociado al botón dentro del dropdown
        clearChatButton.addEventListener('click', () => {
            // Ocultar el dropdown antes de mostrar el prompt
            settingsDropdown.style.display = 'none';

            // Usar prompt() para solicitar la clave
            const enteredPassword = prompt("Ingresa la clave para limpiar el chat:");

            // Verificar la clave
            if (enteredPassword === CLEAR_CHAT_PASSWORD) {
                // Si la clave es correcta, eliminar el nodo 'messages' de Realtime Database
                messagesRef.remove()
                    .then(() => {
                        console.log("Chat limpiado exitosamente en Realtime Database!");
                        // La UI se actualizará automáticamente gracias al listener on 'child_added'
                    })
                    .catch((error) => {
                        console.error("Error al limpiar el chat en Realtime Database:", error);
                        // Mostrar mensaje de error al usuario
                    });
            } else {
                // Si la clave es incorrecta
                console.log("Clave incorrecta. El chat no fue limpiado.");
                // Mostrar mensaje de clave incorrecta al usuario
            }
        });


        // --- Lógica del Botón de Emoji y Selector ---

        // Lista de emojis para el selector
        const emojis = ['😊', '😂', '❤️', '👍', '🙏', '😢', '😍', '🥳', '😎', '🤩', '😭', '🥰', '😘'];

        // Llenar el selector de emojis
        emojis.forEach(emoji => {
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = emoji;
            emojiPicker.appendChild(emojiSpan);

            // Añadir listener para insertar el emoji en el input
            emojiSpan.addEventListener('click', () => {
                insertEmoji(emoji);
                // Opcional: Ocultar el selector después de seleccionar un emoji
                // emojiPicker.style.display = 'none';
            });
        });

        // Función para insertar emoji en el campo de input
        function insertEmoji(emoji) {
            const input = messageInput;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;

            // Insertar el emoji en la posición del cursor
            input.value = value.substring(0, start) + emoji + value.substring(end);

            // Mover el cursor al final del emoji insertado
            input.selectionStart = input.selectionEnd = start + emoji.length;

            input.focus(); // Volver a enfocar el input
            // Disparar el evento 'input' manualmente para actualizar el indicador de escribiendo
            input.dispatchEvent(new Event('input'));
        }


        // Listener para el botón de emoji para mostrar/ocultar el selector
        emojiButton.addEventListener('click', (event) => {
            // Prevenir que el clic en el botón cierre el selector inmediatamente
            event.stopPropagation();
             // Ocultar el dropdown de settings si está visible
             settingsDropdown.style.display = 'none';

            if (emojiPicker.style.display === 'flex') {
                emojiPicker.style.display = 'none';
            } else {
                // Posicionar el selector justo encima de la barra de input
                // bottom del selector = altura del área de input + padding/margen
                const inputAreaHeight = messageInputArea.offsetHeight; // Obtener la altura del área de input fija
                emojiPicker.style.bottom = `${inputAreaHeight + 10}px`; // 10px de margen
                emojiPicker.style.display = 'flex';
            }
        });

        // Ocultar el selector de emojis y el dropdown de settings si se hace clic fuera de ellos
        document.addEventListener('click', (event) => {
            // Si el clic no fue dentro del selector de emojis ni en el botón de emoji
            if (!emojiPicker.contains(event.target) && event.target !== emojiButton) {
                emojiPicker.style.display = 'none';
            }
             // Si el clic no fue dentro del dropdown de settings ni en el botón de settings
             if (!settingsDropdown.contains(event.target) && event.target !== settingsButton) {
                 settingsDropdown.style.display = 'none';
             }
        });


        // --- Lógica para Ajustar Layout con Teclado Virtual ---

        // Listener para el evento resize de la ventana
        window.addEventListener('resize', () => {
            // Ajustar el padding inferior de la caja de chat para dejar espacio para la barra de input fija
            // Esto se hace en cada resize porque la altura del área de input podría cambiar ligeramente
            const inputAreaHeight = messageInputArea.offsetHeight;
            chatBox.style.paddingBottom = `${inputAreaHeight + 20}px`; // Añadir un poco extra

            console.log(`Resize: Ajustando paddingBottom del chatBox a ${chatBox.style.paddingBottom}`);
        });

        // Listener para el evento 'focus' en el input de mensaje
        messageInput.addEventListener('focus', () => {
             // Intentar scrollear la caja de chat al final cuando el input recibe foco
             // Esto ayuda a asegurar que la barra de input sea visible
             setTimeout(() => {
                 chatBox.scrollTop = chatBox.scrollHeight;
                 console.log("Input enfocado, scrolleando chatBox al final con retraso.");
             }, 100); // Retraso para dar tiempo al layout a ajustarse
        });


        // --- Lógica de Responder Mensajes ---

        // Función para iniciar el modo de respuesta
        function startReply(messageData) {
            replyingToMessage = messageData; // Almacenar los datos del mensaje
            replyNameSpan.textContent = messageData.name + ':';
            // Mostrar un fragmento del texto o indicar que es un archivo
            replyTextSpan.textContent = messageData.text ? messageData.text.substring(0, 50) + (messageData.text.length > 50 ? '...' : '') : 'Archivo'; // Asumiendo solo texto por ahora

            replyPreview.style.display = 'flex'; // Mostrar la vista previa
            messageInput.focus(); // Poner el foco en el campo de mensaje
        }

        // Función para cancelar el modo de respuesta
        function cancelReply() {
            replyingToMessage = null; // Limpiar la referencia al mensaje
            replyPreview.style.display = 'none'; // Ocultar la vista previa
            replyNameSpan.textContent = '';
            replyTextSpan.textContent = '';
        }

        // Listener para el botón de cancelar respuesta
        cancelReplyButton.addEventListener('click', cancelReply);


        // --- Lógica del Botón de Configuración y Dropdown ---

        // Listener para el botón de configuración para mostrar/ocultar el dropdown
        settingsButton.addEventListener('click', (event) => {
            // Prevenir que el clic en el botón cierre el dropdown inmediatamente
            event.stopPropagation();
            // Ocultar el selector de emojis si está visible
            emojiPicker.style.display = 'none';

            if (settingsDropdown.style.display === 'flex') {
                settingsDropdown.style.display = 'none';
            } else {
                // Posicionar el dropdown justo debajo y a la derecha del botón de settings
                // Esto se maneja principalmente con CSS position: absolute y top/right
                settingsDropdown.style.display = 'flex';
                // La posición top y right ya están definidas en CSS, pero podrías ajustarlas dinámicamente si fuera necesario
                // const settingsButtonRect = settingsButton.getBoundingClientRect();
                // settingsDropdown.style.top = `${settingsButtonRect.bottom + 5}px`; // 5px debajo del botón
                // settingsDropdown.style.right = `${window.innerWidth - settingsButtonRect.right}px`; // Alinear a la derecha del botón
            }
        });


        // Comprobar si hay un nombre guardado en localStorage al cargar la página
        const savedName = localStorage.getItem('chatName');
        if (savedName) {
            nameInput.value = savedName; // Rellenar el campo de nombre
            startChatButton.click(); // Simular clic en el botón para iniciar el chat automáticamente
        }

        // Ajustes iniciales al cargar la página
        window.onload = function() {
             loadMessages(); // Asegurarse de que los mensajes se carguen
             setupTypingIndicator(); // Configurar el indicador de escribiendo
             // Ajustar el padding inferior del chatBox al cargar
             const inputAreaHeight = messageInputArea.offsetHeight;
             chatBox.style.paddingBottom = `${inputAreaHeight + 20}px`; // Añadir un poco extra

             // Intentar desbloquear el audio aquí también si es necesario
             if (notificationSound) {
                 notificationSound.volume = 0; // Volumen a cero
                 notificationSound.play().then(() => {
                     notificationSound.pause(); // Pausar inmediatamente
                     notificationSound.volume = 1; // Restaurar volumen
                 }).catch(error => {
                     console.error("Audio unlock failed (user interaction needed):", error);
                 });
             }
        };


    </script>

</body>
</html>
